<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomo Drive ~ Chill & Focus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS Custom Properties - Vaporwave/Hello Kitty Theme ===== */
        :root {
            /* Vaporwave Pinks */
            --pink-light: #ffd6e0;
            --pink-main: #ff8fab;
            --pink-deep: #ff5c8d;
            --pink-dark: #c94277;

            /* Vaporwave Accents */
            --cyan: #7fefef;
            --cyan-dark: #4ecdc4;
            --purple: #c792ea;
            --purple-dark: #9b6dff;
            --peach: #ffb5a7;
            --mint: #b5ead7;
            --lavender: #e2d1f9;
            --yellow: #fff3b0;

            /* Sky Gradient Colors */
            --sky-top: #ff9a9e;
            --sky-mid: #fecfef;
            --sky-bottom: #ffdde1;

            /* Night Sky */
            --night-top: #2d1b4e;
            --night-mid: #4a2c7a;
            --night-bottom: #7b4b94;

            /* UI Colors */
            --card-bg: rgba(255, 255, 255, 0.92);
            --card-border: rgba(255, 143, 171, 0.4);
            --text-primary: #5c4158;
            --text-secondary: #8b7086;
            --text-muted: #b8a5b3;

            /* Game Colors */
            --coin-gold: #ffd700;
            --coin-shine: #fff8dc;

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        [data-theme="night"] {
            --sky-top: var(--night-top);
            --sky-mid: var(--night-mid);
            --sky-bottom: var(--night-bottom);
            --card-bg: rgba(45, 27, 78, 0.95);
            --card-border: rgba(199, 146, 234, 0.4);
            --text-primary: #f0e6f5;
            --text-secondary: #c9b8d4;
            --text-muted: #8b7a96;
        }

        /* ===== Reset & Base ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-mid) 50%, var(--sky-bottom) 100%);
            transition: background var(--transition-slow);
            image-rendering: pixelated;
        }

        /* ===== Pixel Font for Game Elements ===== */
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }

        /* ===== Game Container ===== */
        .game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 1s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* ===== Parallax Layers ===== */
        .parallax-layer {
            position: absolute;
            left: 0;
            width: 200%;
            background-repeat: repeat-x;
            image-rendering: pixelated;
        }

        /* Stars Layer (Night only) */
        .stars-layer {
            top: 0;
            height: 40%;
            opacity: 0;
            transition: opacity var(--transition-slow);
        }

        [data-theme="night"] .stars-layer {
            opacity: 1;
        }

        /* Clouds Layer */
        .clouds-layer {
            top: 5%;
            height: 25%;
            animation: parallax-slow 120s linear infinite;
        }

        /* Mountains Layer */
        .mountains-layer {
            bottom: 35%;
            height: 30%;
            animation: parallax-medium 80s linear infinite;
        }

        /* City/Buildings Layer */
        .buildings-layer {
            bottom: 20%;
            height: 25%;
            animation: parallax-fast 40s linear infinite;
        }

        /* Ground/Road Layer */
        .ground-layer {
            bottom: 0;
            height: 22%;
        }

        /* Road markings animation */
        .road-markings {
            position: absolute;
            bottom: 8%;
            left: 0;
            width: 200%;
            height: 4px;
            animation: road-move 2s linear infinite;
        }

        @keyframes parallax-slow {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        @keyframes parallax-medium {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        @keyframes parallax-fast {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        @keyframes road-move {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100px); }
        }

        /* Pause animations when not driving */
        .game-container:not(.driving) .clouds-layer {
            animation-play-state: paused;
        }
        .game-container:not(.driving) .mountains-layer {
            animation-play-state: paused;
        }
        .game-container:not(.driving) .buildings-layer {
            animation-play-state: paused;
        }
        .game-container:not(.driving) .road-markings {
            animation-play-state: paused;
        }

        /* ===== Pixel Art Sun/Moon ===== */
        .celestial {
            position: absolute;
            top: 8%;
            right: 15%;
            width: 60px;
            height: 60px;
            transition: all var(--transition-slow);
        }

        /* ===== Car ===== */
        .car-container {
            position: absolute;
            bottom: 12%;
            left: 20%;
            z-index: 50;
            transition: transform var(--transition-medium);
        }

        .car {
            width: 120px;
            height: 60px;
            position: relative;
            transition: filter var(--transition-medium);
        }

        .car.driving {
            animation: car-bounce 0.3s ease-in-out infinite;
        }

        @keyframes car-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* ===== Coins Floating Animation ===== */
        .floating-coins {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 60;
        }

        .floating-coin {
            position: absolute;
            font-size: 24px;
            animation: coin-float 2s ease-out forwards;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        @keyframes coin-float {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        /* ===== Main UI Card ===== */
        .ui-card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 3px solid var(--card-border);
            border-radius: 24px;
            padding: 32px 40px;
            text-align: center;
            box-shadow:
                0 10px 40px rgba(255, 92, 141, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            backdrop-filter: blur(10px);
            z-index: 100;
            min-width: 340px;
            transition: background var(--transition-slow), border-color var(--transition-slow);
        }

        /* Cute decorative bow */
        .ui-card::before {
            content: 'üéÄ';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
        }

        /* ===== Top Bar (Coins & Settings) ===== */
        .top-bar {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 150;
        }

        .coin-display {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            padding: 10px 18px;
            border-radius: 50px;
            border: 2px solid var(--coin-gold);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .coin-icon {
            font-size: 20px;
            animation: coin-spin 3s ease-in-out infinite;
        }

        @keyframes coin-spin {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        .coin-count {
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            color: var(--text-primary);
        }

        .top-buttons {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--card-bg);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform var(--transition-fast), box-shadow var(--transition-medium);
            border: 2px solid var(--card-border);
        }

        .icon-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        /* ===== Mode Indicator ===== */
        .mode-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
            transition: all var(--transition-medium);
        }

        .mode-badge.work {
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
            color: white;
        }

        .mode-badge.break {
            background: linear-gradient(135deg, var(--mint), var(--cyan-dark));
            color: var(--text-primary);
        }

        .session-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* ===== Timer Display ===== */
        .timer-wrapper {
            position: relative;
            margin: 20px auto;
        }

        .timer-ring {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }

        .timer-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-ring-bg {
            fill: none;
            stroke: var(--pink-light);
            stroke-width: 8;
        }

        .timer-ring-progress {
            fill: none;
            stroke: url(#timerGradient);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .timer-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .timer-time {
            font-family: 'Press Start 2P', cursive;
            font-size: 32px;
            color: var(--text-primary);
            text-shadow: 2px 2px 0 var(--pink-light);
        }

        .timer-time.running {
            animation: timer-pulse 1.5s ease-in-out infinite;
        }

        @keyframes timer-pulse {
            0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.02); }
        }

        .timer-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ===== Control Buttons ===== */
        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 24px 0 20px;
        }

        .btn {
            font-family: 'Quicksand', sans-serif;
            font-size: 14px;
            font-weight: 600;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent);
            border-radius: 50px 50px 0 0;
            pointer-events: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 92, 141, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 92, 141, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: var(--lavender);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary:hover {
            background: var(--purple);
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ===== Stats Row ===== */
        .stats-row {
            display: flex;
            justify-content: center;
            gap: 24px;
            padding-top: 16px;
            border-top: 2px dashed var(--pink-light);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: 'Press Start 2P', cursive;
            font-size: 18px;
            color: var(--pink-deep);
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        /* ===== Shop Panel ===== */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(93, 65, 88, 0.6);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
            z-index: 200;
            backdrop-filter: blur(5px);
        }

        .panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .shop-panel, .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg);
            border: 3px solid var(--card-border);
            border-radius: 24px;
            padding: 32px;
            max-width: 420px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
            z-index: 201;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .shop-panel.open, .settings-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px dashed var(--pink-light);
        }

        .panel-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            color: var(--text-primary);
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--pink-light);
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .close-btn:hover {
            background: var(--pink-main);
            color: white;
            transform: rotate(90deg);
        }

        /* Shop Items */
        .shop-section {
            margin-bottom: 24px;
        }

        .shop-section-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .car-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .car-option {
            background: var(--lavender);
            border: 3px solid transparent;
            border-radius: 16px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .car-option:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .car-option.selected {
            border-color: var(--pink-deep);
            background: var(--pink-light);
        }

        .car-option.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .car-option.locked::after {
            content: 'üîí';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
        }

        .car-preview {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .car-name {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .car-price {
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            color: var(--coin-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .car-price.owned {
            color: var(--cyan-dark);
        }

        /* ===== Settings Panel ===== */
        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--pink-light);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 13px;
            color: var(--text-primary);
        }

        .setting-input {
            width: 70px;
            padding: 8px 10px;
            border: 2px solid var(--pink-light);
            border-radius: 10px;
            background: white;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            text-align: center;
            transition: border-color var(--transition-medium);
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--pink-main);
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--lavender);
            border-radius: 14px;
            cursor: pointer;
            transition: background-color var(--transition-medium);
        }

        .toggle.active {
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform var(--transition-medium);
        }

        .toggle.active::after {
            transform: translateX(24px);
        }

        /* Range Slider */
        .setting-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100px;
            height: 8px;
            background: var(--lavender);
            border-radius: 4px;
            outline: none;
        }

        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(255, 92, 141, 0.4);
        }

        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            gap: 8px;
        }

        .theme-btn {
            padding: 8px 14px;
            border: 2px solid var(--pink-light);
            border-radius: 10px;
            background: white;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .theme-btn.active {
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
            color: white;
            border-color: var(--pink-deep);
        }

        /* Settings Actions */
        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 2px dashed var(--pink-light);
        }

        .btn-danger {
            background: transparent;
            border: 2px solid var(--pink-deep);
            color: var(--pink-deep);
        }

        .btn-danger:hover {
            background: var(--pink-deep);
            color: white;
        }

        /* ===== Toast Notification ===== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(50px);
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 14px 24px;
            border-radius: 50px;
            border: 2px solid var(--pink-main);
            box-shadow: 0 8px 32px rgba(255, 92, 141, 0.3);
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
            z-index: 300;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            visibility: visible;
        }

        /* ===== Work Mode Overlay ===== */
        .work-overlay {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid var(--pink-light);
            font-size: 12px;
            color: var(--text-secondary);
            z-index: 90;
            opacity: 0;
            transition: opacity var(--transition-medium);
            pointer-events: none;
        }

        .work-overlay.show {
            opacity: 1;
        }

        /* ===== Mobile Responsive ===== */
        @media (max-width: 480px) {
            .ui-card {
                min-width: auto;
                width: 90%;
                padding: 24px 20px;
            }

            .timer-ring {
                width: 160px;
                height: 160px;
            }

            .timer-time {
                font-size: 24px;
            }

            .controls {
                flex-wrap: wrap;
            }

            .btn {
                padding: 10px 18px;
                font-size: 13px;
            }

            .car-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .car-container {
                left: 10%;
            }

            .car {
                width: 80px;
                height: 40px;
            }
        }

        /* ===== Cute Sparkle Effect ===== */
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }

        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            pointer-events: none;
        }

        .sparkle::before {
            content: '‚ú®';
            font-size: 16px;
            animation: sparkle 1.5s ease-in-out infinite;
        }

        /* ===== Break Mode Glow ===== */
        .break-glow {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            background: radial-gradient(ellipse at center, rgba(181, 234, 215, 0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity var(--transition-slow);
            z-index: 5;
        }

        .break-glow.active {
            opacity: 1;
        }

        /* ===== Custom Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--pink-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--pink-main);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--pink-deep);
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <!-- SVG Definitions -->
        <svg style="position: absolute; width: 0; height: 0;">
            <defs>
                <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ff8fab"/>
                    <stop offset="100%" style="stop-color:#ff5c8d"/>
                </linearGradient>
                <linearGradient id="breakGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#b5ead7"/>
                    <stop offset="100%" style="stop-color:#4ecdc4"/>
                </linearGradient>
            </defs>
        </svg>

        <!-- Break Mode Glow -->
        <div class="break-glow" id="breakGlow"></div>

        <!-- Parallax Background Layers -->
        <canvas class="parallax-layer stars-layer" id="starsCanvas"></canvas>
        <canvas class="parallax-layer clouds-layer" id="cloudsCanvas"></canvas>
        <canvas class="parallax-layer mountains-layer" id="mountainsCanvas"></canvas>
        <canvas class="parallax-layer buildings-layer" id="buildingsCanvas"></canvas>
        <canvas class="parallax-layer ground-layer" id="groundCanvas"></canvas>

        <!-- Celestial Body (Sun/Moon) -->
        <canvas class="celestial" id="celestialCanvas" width="60" height="60"></canvas>

        <!-- Floating Coins Container -->
        <div class="floating-coins" id="floatingCoins"></div>

        <!-- Car -->
        <div class="car-container" id="carContainer">
            <canvas class="car" id="carCanvas" width="120" height="60"></canvas>
        </div>

        <!-- Top Bar -->
        <div class="top-bar">
            <div class="coin-display">
                <span class="coin-icon">ü™ô</span>
                <span class="coin-count pixel-font" id="coinCount">0</span>
            </div>
            <div class="top-buttons">
                <button class="icon-btn" id="shopBtn" title="Shop">üõí</button>
                <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Main UI Card -->
        <div class="ui-card">
            <div class="mode-badge work" id="modeBadge">Focus Time</div>
            <div class="session-info" id="sessionInfo">Session 1 of 4 üçÖ</div>

            <div class="timer-wrapper">
                <div class="timer-ring">
                    <svg viewBox="0 0 100 100">
                        <circle class="timer-ring-bg" cx="50" cy="50" r="45"/>
                        <circle class="timer-ring-progress" id="progressRing" cx="50" cy="50" r="45"/>
                    </svg>
                    <div class="timer-display">
                        <div class="timer-time pixel-font" id="timerDisplay">25:00</div>
                        <div class="timer-label" id="timerLabel">stay focused!</div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn">‚ñ∂ Start</button>
                <button class="btn btn-secondary" id="pauseBtn" disabled>‚è∏ Pause</button>
                <button class="btn btn-secondary" id="resetBtn">‚Ü∫ Reset</button>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="todayPomodoros">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCoins">0</div>
                    <div class="stat-label">Total ü™ô</div>
                </div>
            </div>
        </div>

        <!-- Work Mode Overlay Message -->
        <div class="work-overlay" id="workOverlay">
            üöó Car is driving... Focus on your work! üí™
        </div>
    </div>

    <!-- Shop Panel Overlay -->
    <div class="panel-overlay" id="shopOverlay"></div>

    <!-- Shop Panel -->
    <div class="shop-panel" id="shopPanel">
        <div class="panel-header">
            <h2 class="panel-title">üõí Car Shop</h2>
            <button class="close-btn" id="closeShopBtn">‚úï</button>
        </div>

        <div class="shop-section">
            <div class="shop-section-title">üöó Choose Your Ride</div>
            <div class="car-grid" id="carGrid">
                <!-- Cars will be populated by JS -->
            </div>
        </div>

        <div class="shop-section">
            <div class="shop-section-title">üí° How to Earn Coins</div>
            <p style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                Complete work sessions and enjoy your breaks! You earn <strong>+1 coin</strong> every few seconds during break time. The longer you rest, the more coins you collect! ü™ô‚ú®
            </p>
        </div>
    </div>

    <!-- Settings Panel Overlay -->
    <div class="panel-overlay" id="settingsOverlay"></div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="panel-header">
            <h2 class="panel-title">‚öôÔ∏è Settings</h2>
            <button class="close-btn" id="closeSettingsBtn">‚úï</button>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">‚è±Ô∏è Timer (minutes)</div>
            <div class="setting-item">
                <span class="setting-label">Work Session</span>
                <input type="number" class="setting-input" id="workDuration" min="1" max="60" value="25">
            </div>
            <div class="setting-item">
                <span class="setting-label">Short Break</span>
                <input type="number" class="setting-input" id="shortBreakDuration" min="1" max="60" value="5">
            </div>
            <div class="setting-item">
                <span class="setting-label">Long Break</span>
                <input type="number" class="setting-input" id="longBreakDuration" min="1" max="60" value="15">
            </div>
            <div class="setting-item">
                <span class="setting-label">Sessions until Long Break</span>
                <input type="number" class="setting-input" id="sessionsUntilLong" min="1" max="10" value="4">
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">üîÑ Auto-Start</div>
            <div class="setting-item">
                <span class="setting-label">Auto-start Breaks</span>
                <div class="toggle" id="autoStartBreaks"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Auto-start Work</span>
                <div class="toggle" id="autoStartWork"></div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">üîî Notifications</div>
            <div class="setting-item">
                <span class="setting-label">Sound</span>
                <div class="toggle active" id="soundEnabled"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Volume</span>
                <input type="range" class="setting-slider" id="volumeSlider" min="0" max="100" value="70">
            </div>
            <div class="setting-item">
                <span class="setting-label">Browser Notifications</span>
                <div class="toggle" id="browserNotifications"></div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">üé® Theme</div>
            <div class="setting-item">
                <span class="setting-label">Time of Day</span>
                <div class="theme-toggle">
                    <button class="theme-btn active" data-theme="day">‚òÄÔ∏è Day</button>
                    <button class="theme-btn" data-theme="night">üåô Night</button>
                </div>
            </div>
        </div>

        <div class="settings-actions">
            <button class="btn btn-secondary" id="resetDefaults">Reset to Defaults</button>
            <button class="btn btn-danger" id="clearAllData">Clear All Data</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== Application State =====
        const state = {
            // Timer state
            isRunning: false,
            isPaused: false,
            timeRemaining: 25 * 60,
            totalTime: 25 * 60,
            currentMode: 'work',
            currentSession: 1,
            completedPomodoros: 0,
            timerInterval: null,
            coinInterval: null,

            // Game state
            coins: 0,
            selectedCar: 'pink',
            ownedCars: ['pink'],

            // Settings
            settings: {
                workDuration: 25,
                shortBreakDuration: 5,
                longBreakDuration: 15,
                sessionsUntilLong: 4,
                autoStartBreaks: false,
                autoStartWork: false,
                soundEnabled: true,
                volume: 70,
                browserNotifications: false,
                theme: 'day'
            },

            // Statistics
            stats: {
                today: 0,
                totalCoins: 0,
                lastResetDate: null
            }
        };

        // ===== Car Definitions =====
        const CARS = [
            { id: 'pink', name: 'Pinky', price: 0, emoji: 'üöó', colors: { body: '#ff8fab', window: '#7fefef', wheel: '#5c4158' } },
            { id: 'lavender', name: 'Dreamy', price: 50, emoji: 'üöô', colors: { body: '#c792ea', window: '#ffd6e0', wheel: '#5c4158' } },
            { id: 'mint', name: 'Minty', price: 100, emoji: 'üöï', colors: { body: '#b5ead7', window: '#fff3b0', wheel: '#5c4158' } },
            { id: 'peach', name: 'Peachy', price: 150, emoji: 'üõª', colors: { body: '#ffb5a7', window: '#7fefef', wheel: '#5c4158' } },
            { id: 'cyan', name: 'Ocean', price: 200, emoji: 'üöê', colors: { body: '#7fefef', window: '#ffd6e0', wheel: '#5c4158' } },
            { id: 'gold', name: 'Luxe', price: 500, emoji: 'üèéÔ∏è', colors: { body: '#ffd700', window: '#ff8fab', wheel: '#5c4158' } }
        ];

        // ===== DOM Elements =====
        const elements = {
            gameContainer: document.getElementById('gameContainer'),
            timerDisplay: document.getElementById('timerDisplay'),
            timerLabel: document.getElementById('timerLabel'),
            modeBadge: document.getElementById('modeBadge'),
            sessionInfo: document.getElementById('sessionInfo'),
            progressRing: document.getElementById('progressRing'),
            startBtn: document.getElementById('startBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            resetBtn: document.getElementById('resetBtn'),
            todayPomodoros: document.getElementById('todayPomodoros'),
            totalCoins: document.getElementById('totalCoins'),
            coinCount: document.getElementById('coinCount'),
            shopBtn: document.getElementById('shopBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            shopPanel: document.getElementById('shopPanel'),
            shopOverlay: document.getElementById('shopOverlay'),
            closeShopBtn: document.getElementById('closeShopBtn'),
            settingsPanel: document.getElementById('settingsPanel'),
            settingsOverlay: document.getElementById('settingsOverlay'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            carGrid: document.getElementById('carGrid'),
            toast: document.getElementById('toast'),
            breakGlow: document.getElementById('breakGlow'),
            workOverlay: document.getElementById('workOverlay'),
            floatingCoins: document.getElementById('floatingCoins'),

            // Canvases
            starsCanvas: document.getElementById('starsCanvas'),
            cloudsCanvas: document.getElementById('cloudsCanvas'),
            mountainsCanvas: document.getElementById('mountainsCanvas'),
            buildingsCanvas: document.getElementById('buildingsCanvas'),
            groundCanvas: document.getElementById('groundCanvas'),
            celestialCanvas: document.getElementById('celestialCanvas'),
            carCanvas: document.getElementById('carCanvas'),

            // Settings inputs
            workDuration: document.getElementById('workDuration'),
            shortBreakDuration: document.getElementById('shortBreakDuration'),
            longBreakDuration: document.getElementById('longBreakDuration'),
            sessionsUntilLong: document.getElementById('sessionsUntilLong'),
            autoStartBreaks: document.getElementById('autoStartBreaks'),
            autoStartWork: document.getElementById('autoStartWork'),
            soundEnabled: document.getElementById('soundEnabled'),
            volumeSlider: document.getElementById('volumeSlider'),
            browserNotifications: document.getElementById('browserNotifications'),
            themeButtons: document.querySelectorAll('.theme-btn'),
            resetDefaults: document.getElementById('resetDefaults'),
            clearAllData: document.getElementById('clearAllData')
        };

        // ===== Pixel Art Drawing Functions =====

        // Draw pixel-style clouds
        function drawClouds(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 2;
            canvas.height = window.innerHeight * 0.25;
            ctx.imageSmoothingEnabled = false;

            const pixelSize = 8;
            const cloudColor = state.settings.theme === 'night' ? 'rgba(199, 146, 234, 0.4)' : 'rgba(255, 255, 255, 0.9)';

            // Cloud pattern
            const clouds = [
                { x: 100, y: 40, size: 1 },
                { x: 300, y: 60, size: 1.5 },
                { x: 550, y: 30, size: 1.2 },
                { x: 800, y: 70, size: 1 },
                { x: 1000, y: 45, size: 1.3 },
                { x: 1250, y: 55, size: 1.1 },
                { x: 1500, y: 35, size: 1.4 },
                { x: 1750, y: 65, size: 1 },
            ];

            clouds.forEach(cloud => {
                drawPixelCloud(ctx, cloud.x, cloud.y, cloud.size, pixelSize, cloudColor);
            });
        }

        function drawPixelCloud(ctx, x, y, scale, pixelSize, color) {
            ctx.fillStyle = color;
            const pattern = [
                [0,0,1,1,1,0,0,0,0,1,1,0,0],
                [0,1,1,1,1,1,0,1,1,1,1,1,0],
                [1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1],
                [0,1,1,1,1,1,1,1,1,1,1,1,0],
            ];

            pattern.forEach((row, py) => {
                row.forEach((pixel, px) => {
                    if (pixel) {
                        ctx.fillRect(
                            x + px * pixelSize * scale,
                            y + py * pixelSize * scale,
                            pixelSize * scale,
                            pixelSize * scale
                        );
                    }
                });
            });
        }

        // Draw pixel mountains
        function drawMountains(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 2;
            canvas.height = window.innerHeight * 0.3;
            ctx.imageSmoothingEnabled = false;

            const baseColor = state.settings.theme === 'night' ? '#4a2c7a' : '#e2d1f9';
            const shadowColor = state.settings.theme === 'night' ? '#2d1b4e' : '#c792ea';
            const snowColor = state.settings.theme === 'night' ? '#9b6dff' : '#ffffff';

            // Draw multiple mountain ranges
            drawMountainRange(ctx, canvas.height, baseColor, shadowColor, snowColor, 0);
            drawMountainRange(ctx, canvas.height * 0.8,
                state.settings.theme === 'night' ? '#7b4b94' : '#ffd6e0',
                state.settings.theme === 'night' ? '#4a2c7a' : '#ff8fab',
                snowColor, canvas.width * 0.3);
        }

        function drawMountainRange(ctx, height, baseColor, shadowColor, snowColor, offset) {
            const pixelSize = 6;
            const peaks = [];

            for (let i = 0; i < 15; i++) {
                peaks.push({
                    x: offset + i * 180 + Math.random() * 60,
                    height: 80 + Math.random() * 100
                });
            }

            peaks.forEach(peak => {
                // Mountain body
                ctx.fillStyle = baseColor;
                for (let y = 0; y < peak.height; y += pixelSize) {
                    const width = (peak.height - y) * 1.2;
                    ctx.fillRect(
                        peak.x - width / 2,
                        height - peak.height + y,
                        width,
                        pixelSize
                    );
                }

                // Shadow side
                ctx.fillStyle = shadowColor;
                for (let y = 0; y < peak.height; y += pixelSize) {
                    const width = (peak.height - y) * 0.6;
                    ctx.fillRect(
                        peak.x,
                        height - peak.height + y,
                        width,
                        pixelSize
                    );
                }

                // Snow cap
                ctx.fillStyle = snowColor;
                for (let y = 0; y < peak.height * 0.25; y += pixelSize) {
                    const width = (peak.height * 0.25 - y) * 1.2;
                    ctx.fillRect(
                        peak.x - width / 2,
                        height - peak.height + y,
                        width,
                        pixelSize
                    );
                }
            });
        }

        // Draw pixel city/buildings
        function drawBuildings(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 2;
            canvas.height = window.innerHeight * 0.25;
            ctx.imageSmoothingEnabled = false;

            const pixelSize = 4;
            const buildings = [];

            // Generate buildings
            for (let i = 0; i < 40; i++) {
                buildings.push({
                    x: i * 80 + Math.random() * 30,
                    width: 40 + Math.random() * 40,
                    height: 50 + Math.random() * 100,
                    color: getRandomBuildingColor()
                });
            }

            buildings.forEach(building => {
                drawPixelBuilding(ctx, building, pixelSize, canvas.height);
            });
        }

        function getRandomBuildingColor() {
            const colors = state.settings.theme === 'night'
                ? ['#2d1b4e', '#4a2c7a', '#7b4b94', '#9b6dff']
                : ['#ffd6e0', '#ffb5a7', '#e2d1f9', '#b5ead7'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function drawPixelBuilding(ctx, building, pixelSize, canvasHeight) {
            // Main building
            ctx.fillStyle = building.color;
            for (let y = 0; y < building.height; y += pixelSize) {
                ctx.fillRect(building.x, canvasHeight - building.height + y, building.width, pixelSize);
            }

            // Windows
            const windowColor = state.settings.theme === 'night' ? '#fff3b0' : '#7fefef';
            const windowOffColor = state.settings.theme === 'night' ? '#4a2c7a' : '#c792ea';

            for (let wy = 10; wy < building.height - 15; wy += 20) {
                for (let wx = 8; wx < building.width - 8; wx += 16) {
                    ctx.fillStyle = Math.random() > 0.3 ? windowColor : windowOffColor;
                    ctx.fillRect(
                        building.x + wx,
                        canvasHeight - building.height + wy,
                        8,
                        12
                    );
                }
            }
        }

        // Draw ground/road
        function drawGround(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight * 0.22;
            ctx.imageSmoothingEnabled = false;

            const pixelSize = 4;

            // Grass
            ctx.fillStyle = state.settings.theme === 'night' ? '#1d3d3a' : '#b5ead7';
            ctx.fillRect(0, 0, canvas.width, canvas.height * 0.4);

            // Road
            ctx.fillStyle = state.settings.theme === 'night' ? '#2d1b4e' : '#e2d1f9';
            ctx.fillRect(0, canvas.height * 0.3, canvas.width, canvas.height * 0.5);

            // Road lines
            ctx.fillStyle = state.settings.theme === 'night' ? '#9b6dff' : '#ffffff';
            for (let x = 0; x < canvas.width; x += 60) {
                ctx.fillRect(x, canvas.height * 0.52, 30, 6);
            }

            // Sidewalk
            ctx.fillStyle = state.settings.theme === 'night' ? '#4a2c7a' : '#ffd6e0';
            ctx.fillRect(0, canvas.height * 0.75, canvas.width, canvas.height * 0.25);

            // Pixel flowers on grass
            const flowerColors = ['#ff8fab', '#fff3b0', '#7fefef', '#c792ea'];
            for (let i = 0; i < 30; i++) {
                ctx.fillStyle = flowerColors[Math.floor(Math.random() * flowerColors.length)];
                const fx = Math.random() * canvas.width;
                const fy = Math.random() * canvas.height * 0.25;
                ctx.fillRect(fx, fy, pixelSize, pixelSize);
            }
        }

        // Draw stars (night mode)
        function drawStars(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 2;
            canvas.height = window.innerHeight * 0.4;
            ctx.imageSmoothingEnabled = false;

            ctx.fillStyle = '#ffffff';
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() > 0.8 ? 3 : 2;
                ctx.fillRect(x, y, size, size);
            }

            // Some twinkling stars (larger)
            ctx.fillStyle = '#fff3b0';
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                ctx.fillRect(x, y, 4, 4);
            }
        }

        // Draw sun/moon
        function drawCelestial(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 60, 60);
            ctx.imageSmoothingEnabled = false;

            const pixelSize = 4;

            if (state.settings.theme === 'night') {
                // Moon
                ctx.fillStyle = '#fff3b0';
                const moonPattern = [
                    [0,0,0,1,1,1,1,0,0,0],
                    [0,0,1,1,1,1,1,1,0,0],
                    [0,1,1,1,1,1,0,0,0,0],
                    [1,1,1,1,1,0,0,0,0,0],
                    [1,1,1,1,1,0,0,0,0,0],
                    [1,1,1,1,1,0,0,0,0,0],
                    [1,1,1,1,1,1,0,0,0,0],
                    [0,1,1,1,1,1,1,0,0,0],
                    [0,0,1,1,1,1,1,1,0,0],
                    [0,0,0,1,1,1,1,0,0,0],
                ];
                moonPattern.forEach((row, py) => {
                    row.forEach((pixel, px) => {
                        if (pixel) {
                            ctx.fillRect(px * pixelSize + 10, py * pixelSize + 10, pixelSize, pixelSize);
                        }
                    });
                });
            } else {
                // Sun
                ctx.fillStyle = '#fff3b0';
                // Sun rays
                ctx.fillRect(28, 2, 4, 8);
                ctx.fillRect(28, 50, 4, 8);
                ctx.fillRect(2, 28, 8, 4);
                ctx.fillRect(50, 28, 8, 4);
                ctx.fillRect(10, 10, 6, 6);
                ctx.fillRect(44, 10, 6, 6);
                ctx.fillRect(10, 44, 6, 6);
                ctx.fillRect(44, 44, 6, 6);

                // Sun body
                ctx.fillStyle = '#ffd700';
                for (let y = 18; y < 42; y += pixelSize) {
                    for (let x = 18; x < 42; x += pixelSize) {
                        const dist = Math.sqrt(Math.pow(x - 30, 2) + Math.pow(y - 30, 2));
                        if (dist < 14) {
                            ctx.fillRect(x, y, pixelSize, pixelSize);
                        }
                    }
                }
            }
        }

        // Draw the car
        function drawCar() {
            const canvas = elements.carCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 120, 60);
            ctx.imageSmoothingEnabled = false;

            const car = CARS.find(c => c.id === state.selectedCar);
            const colors = car.colors;
            const pixelSize = 4;

            // Car body (main)
            ctx.fillStyle = colors.body;
            // Bottom part
            ctx.fillRect(8, 32, 104, 16);
            // Top part
            ctx.fillRect(24, 16, 64, 20);

            // Roof curve
            ctx.fillRect(20, 20, 72, 4);
            ctx.fillRect(16, 24, 80, 4);

            // Windows
            ctx.fillStyle = colors.window;
            ctx.fillRect(28, 20, 24, 12);
            ctx.fillRect(56, 20, 28, 12);

            // Window shine
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fillRect(30, 22, 4, 8);
            ctx.fillRect(58, 22, 4, 8);

            // Wheels
            ctx.fillStyle = colors.wheel;
            // Front wheel
            ctx.fillRect(20, 44, 20, 12);
            ctx.fillRect(24, 48, 12, 4);
            // Back wheel
            ctx.fillRect(80, 44, 20, 12);
            ctx.fillRect(84, 48, 12, 4);

            // Wheel shine
            ctx.fillStyle = '#8b7a96';
            ctx.fillRect(26, 46, 8, 8);
            ctx.fillRect(86, 46, 8, 8);

            // Headlights
            ctx.fillStyle = '#fff3b0';
            ctx.fillRect(104, 36, 8, 8);

            // Tail lights
            ctx.fillStyle = '#ff5c8d';
            ctx.fillRect(8, 36, 6, 6);

            // Cute face on car (Hello Kitty inspired)
            ctx.fillStyle = '#5c4158';
            // Eyes
            ctx.fillRect(36, 24, 4, 4);
            ctx.fillRect(48, 24, 4, 4);

            // Blush
            ctx.fillStyle = '#ff8fab';
            ctx.fillRect(32, 28, 4, 2);
            ctx.fillRect(52, 28, 4, 2);

            // Little bow on top
            ctx.fillStyle = '#ff5c8d';
            ctx.fillRect(52, 12, 8, 4);
            ctx.fillRect(48, 14, 4, 4);
            ctx.fillRect(60, 14, 4, 4);
        }

        // ===== Audio Context =====
        let audioContext = null;

        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            return audioContext;
        }

        function playSound(type = 'complete') {
            if (!state.settings.soundEnabled) return;

            try {
                const ctx = initAudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                const volume = state.settings.volume / 100 * 0.2;
                gainNode.gain.setValueAtTime(volume, ctx.currentTime);

                if (type === 'complete') {
                    // Cute completion jingle
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
                    oscillator.frequency.setValueAtTime(1046.50, ctx.currentTime + 0.3);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.5);
                } else if (type === 'coin') {
                    // Coin collect sound
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(987.77, ctx.currentTime);
                    oscillator.frequency.setValueAtTime(1318.51, ctx.currentTime + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.15);
                } else if (type === 'break') {
                    // Break start sound
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(783.99, ctx.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.15);
                    oscillator.frequency.setValueAtTime(523.25, ctx.currentTime + 0.3);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.5);
                }
            } catch (e) {
                console.warn('Audio failed:', e);
            }
        }

        // ===== Progress Ring =====
        const ringCircumference = 2 * Math.PI * 45;
        elements.progressRing.style.strokeDasharray = ringCircumference;

        function updateProgressRing() {
            const progress = state.timeRemaining / state.totalTime;
            const offset = ringCircumference * (1 - progress);
            elements.progressRing.style.strokeDashoffset = offset;

            // Update gradient based on mode
            if (state.currentMode === 'work') {
                elements.progressRing.style.stroke = 'url(#timerGradient)';
            } else {
                elements.progressRing.style.stroke = 'url(#breakGradient)';
            }
        }

        // ===== Timer Functions =====
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            elements.timerDisplay.textContent = formatTime(state.timeRemaining);
            updateProgressRing();
            document.title = `${formatTime(state.timeRemaining)} - ${state.currentMode === 'work' ? 'üí™ Focus' : '‚òï Break'} | Pomo Drive`;
        }

        function setMode(mode) {
            state.currentMode = mode;

            if (mode === 'work') {
                elements.modeBadge.className = 'mode-badge work';
                elements.modeBadge.textContent = 'Focus Time';
                elements.timerLabel.textContent = 'stay focused!';
                state.totalTime = state.settings.workDuration * 60;
                elements.breakGlow.classList.remove('active');
                elements.workOverlay.classList.add('show');
                stopCoinGeneration();
            } else {
                elements.modeBadge.className = 'mode-badge break';
                elements.modeBadge.textContent = mode === 'shortBreak' ? 'Short Break' : 'Long Break';
                elements.timerLabel.textContent = 'relax & earn coins! ü™ô';
                state.totalTime = mode === 'shortBreak'
                    ? state.settings.shortBreakDuration * 60
                    : state.settings.longBreakDuration * 60;
                elements.breakGlow.classList.add('active');
                elements.workOverlay.classList.remove('show');
            }

            state.timeRemaining = state.totalTime;
            updateDisplay();
        }

        function updateSessionInfo() {
            elements.sessionInfo.textContent = `Session ${state.currentSession} of ${state.settings.sessionsUntilLong} üçÖ`;
        }

        function startTimer() {
            if (state.isRunning && !state.isPaused) return;

            initAudioContext();
            state.isRunning = true;
            state.isPaused = false;

            elements.startBtn.textContent = 'üöó Driving...';
            elements.startBtn.disabled = true;
            elements.pauseBtn.disabled = false;
            elements.timerDisplay.classList.add('running');
            elements.gameContainer.classList.add('driving');
            elements.carCanvas.classList.add('driving');

            // Show work overlay during work mode
            if (state.currentMode === 'work') {
                elements.workOverlay.classList.add('show');
            } else {
                startCoinGeneration();
            }

            state.timerInterval = setInterval(() => {
                state.timeRemaining--;
                updateDisplay();

                if (state.timeRemaining <= 0) {
                    timerComplete();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (!state.isRunning) return;

            state.isPaused = true;
            clearInterval(state.timerInterval);
            stopCoinGeneration();

            elements.startBtn.textContent = '‚ñ∂ Resume';
            elements.startBtn.disabled = false;
            elements.pauseBtn.disabled = true;
            elements.timerDisplay.classList.remove('running');
            elements.gameContainer.classList.remove('driving');
            elements.carCanvas.classList.remove('driving');
            elements.workOverlay.classList.remove('show');
        }

        function resetTimer() {
            clearInterval(state.timerInterval);
            stopCoinGeneration();
            state.isRunning = false;
            state.isPaused = false;

            setMode(state.currentMode);

            elements.startBtn.textContent = '‚ñ∂ Start';
            elements.startBtn.disabled = false;
            elements.pauseBtn.disabled = true;
            elements.timerDisplay.classList.remove('running');
            elements.gameContainer.classList.remove('driving');
            elements.carCanvas.classList.remove('driving');
            elements.workOverlay.classList.remove('show');

            updateDisplay();
        }

        function timerComplete() {
            clearInterval(state.timerInterval);
            stopCoinGeneration();
            state.isRunning = false;
            state.isPaused = false;
            elements.timerDisplay.classList.remove('running');
            elements.gameContainer.classList.remove('driving');
            elements.carCanvas.classList.remove('driving');
            elements.workOverlay.classList.remove('show');

            if (state.currentMode === 'work') {
                state.completedPomodoros++;
                state.stats.today++;
                updateStatsDisplay();
                playSound('complete');
                showBrowserNotification('Great work! üéâ', 'Time for a well-deserved break!');
                showToast('üéâ Session complete! Time to relax!');

                if (state.currentSession >= state.settings.sessionsUntilLong) {
                    setMode('longBreak');
                    state.currentSession = 1;
                } else {
                    setMode('shortBreak');
                    state.currentSession++;
                }

                updateSessionInfo();

                if (state.settings.autoStartBreaks) {
                    setTimeout(() => {
                        startTimer();
                        startCoinGeneration();
                    }, 1000);
                } else {
                    elements.startBtn.textContent = '‚ñ∂ Start Break';
                    elements.startBtn.disabled = false;
                }
            } else {
                playSound('break');
                showBrowserNotification('Break over! üí™', 'Ready to focus again?');
                showToast('‚òï Break complete! Back to work!');
                setMode('work');

                if (state.settings.autoStartWork) {
                    setTimeout(startTimer, 1000);
                } else {
                    elements.startBtn.textContent = '‚ñ∂ Start';
                    elements.startBtn.disabled = false;
                }
            }

            elements.pauseBtn.disabled = true;
            saveState();
        }

        // ===== Coin System =====
        function startCoinGeneration() {
            if (state.coinInterval) return;

            state.coinInterval = setInterval(() => {
                if (state.currentMode !== 'work' && state.isRunning && !state.isPaused) {
                    addCoins(1);
                    createFloatingCoin();
                }
            }, 3000); // Earn 1 coin every 3 seconds during break
        }

        function stopCoinGeneration() {
            if (state.coinInterval) {
                clearInterval(state.coinInterval);
                state.coinInterval = null;
            }
        }

        function addCoins(amount) {
            state.coins += amount;
            state.stats.totalCoins += amount;
            updateCoinDisplay();
            playSound('coin');
            saveState();
        }

        function updateCoinDisplay() {
            elements.coinCount.textContent = state.coins;
            elements.totalCoins.textContent = state.stats.totalCoins;
        }

        function createFloatingCoin() {
            const coin = document.createElement('div');
            coin.className = 'floating-coin';
            coin.textContent = 'ü™ô';
            coin.style.left = `${20 + Math.random() * 20}%`;
            coin.style.bottom = '20%';
            elements.floatingCoins.appendChild(coin);

            setTimeout(() => coin.remove(), 2000);
        }

        // ===== Shop Functions =====
        function populateShop() {
            elements.carGrid.innerHTML = '';

            CARS.forEach(car => {
                const owned = state.ownedCars.includes(car.id);
                const selected = state.selectedCar === car.id;
                const canAfford = state.coins >= car.price;

                const div = document.createElement('div');
                div.className = `car-option ${selected ? 'selected' : ''} ${!owned && !canAfford ? 'locked' : ''}`;
                div.innerHTML = `
                    <div class="car-preview">${car.emoji}</div>
                    <div class="car-name">${car.name}</div>
                    <div class="car-price ${owned ? 'owned' : ''}">
                        ${owned ? '‚úì Owned' : `ü™ô ${car.price}`}
                    </div>
                `;

                div.addEventListener('click', () => {
                    if (owned) {
                        selectCar(car.id);
                    } else if (canAfford) {
                        buyCar(car);
                    } else {
                        showToast(`Need ${car.price - state.coins} more coins! ü™ô`);
                    }
                });

                elements.carGrid.appendChild(div);
            });
        }

        function selectCar(carId) {
            state.selectedCar = carId;
            drawCar();
            populateShop();
            saveState();
            showToast(`Selected ${CARS.find(c => c.id === carId).name}! üöó`);
        }

        function buyCar(car) {
            state.coins -= car.price;
            state.ownedCars.push(car.id);
            selectCar(car.id);
            updateCoinDisplay();
            showToast(`Bought ${car.name}! üéâ`);
        }

        // ===== Browser Notifications =====
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('Browser notifications not supported');
                return false;
            }
            if (Notification.permission === 'granted') return true;
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return false;
        }

        function showBrowserNotification(title, body) {
            if (!state.settings.browserNotifications) return;
            if (Notification.permission !== 'granted') return;
            try {
                new Notification(title, { body });
            } catch (e) {
                console.warn('Notification failed:', e);
            }
        }

        // ===== Panel Functions =====
        function openShop() {
            // Can only open shop during break or when not running
            if (state.currentMode === 'work' && state.isRunning && !state.isPaused) {
                showToast('Finish your work session first! üí™');
                return;
            }
            populateShop();
            elements.shopPanel.classList.add('open');
            elements.shopOverlay.classList.add('open');
        }

        function closeShop() {
            elements.shopPanel.classList.remove('open');
            elements.shopOverlay.classList.remove('open');
        }

        function openSettings() {
            if (state.currentMode === 'work' && state.isRunning && !state.isPaused) {
                showToast('Finish your work session first! üí™');
                return;
            }
            elements.settingsPanel.classList.add('open');
            elements.settingsOverlay.classList.add('open');
        }

        function closeSettings() {
            elements.settingsPanel.classList.remove('open');
            elements.settingsOverlay.classList.remove('open');
        }

        // ===== Settings Functions =====
        function applySettings() {
            state.settings.workDuration = Math.max(1, Math.min(60, parseInt(elements.workDuration.value) || 25));
            state.settings.shortBreakDuration = Math.max(1, Math.min(60, parseInt(elements.shortBreakDuration.value) || 5));
            state.settings.longBreakDuration = Math.max(1, Math.min(60, parseInt(elements.longBreakDuration.value) || 15));
            state.settings.sessionsUntilLong = Math.max(1, Math.min(10, parseInt(elements.sessionsUntilLong.value) || 4));

            elements.workDuration.value = state.settings.workDuration;
            elements.shortBreakDuration.value = state.settings.shortBreakDuration;
            elements.longBreakDuration.value = state.settings.longBreakDuration;
            elements.sessionsUntilLong.value = state.settings.sessionsUntilLong;

            state.settings.volume = parseInt(elements.volumeSlider.value);

            updateSessionInfo();

            if (!state.isRunning) {
                setMode(state.currentMode);
            }

            saveState();
        }

        function initSettingsUI() {
            elements.workDuration.value = state.settings.workDuration;
            elements.shortBreakDuration.value = state.settings.shortBreakDuration;
            elements.longBreakDuration.value = state.settings.longBreakDuration;
            elements.sessionsUntilLong.value = state.settings.sessionsUntilLong;
            elements.volumeSlider.value = state.settings.volume;

            if (state.settings.autoStartBreaks) elements.autoStartBreaks.classList.add('active');
            if (state.settings.autoStartWork) elements.autoStartWork.classList.add('active');
            if (state.settings.soundEnabled) elements.soundEnabled.classList.add('active');
            if (state.settings.browserNotifications) elements.browserNotifications.classList.add('active');

            elements.themeButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === state.settings.theme);
            });
        }

        function setTheme(theme) {
            state.settings.theme = theme;
            document.documentElement.setAttribute('data-theme', theme === 'day' ? '' : 'night');

            elements.themeButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });

            // Redraw all canvases
            drawAllLayers();
            saveState();
        }

        function drawAllLayers() {
            drawStars(elements.starsCanvas);
            drawClouds(elements.cloudsCanvas);
            drawMountains(elements.mountainsCanvas);
            drawBuildings(elements.buildingsCanvas);
            drawGround(elements.groundCanvas);
            drawCelestial(elements.celestialCanvas);
            drawCar();
        }

        // ===== Stats Display =====
        function updateStatsDisplay() {
            const today = new Date().toDateString();
            if (state.stats.lastResetDate !== today) {
                state.stats.today = 0;
                state.stats.lastResetDate = today;
            }
            elements.todayPomodoros.textContent = state.stats.today;
            elements.totalCoins.textContent = state.stats.totalCoins;
        }

        // ===== Local Storage =====
        function saveState() {
            const data = {
                coins: state.coins,
                selectedCar: state.selectedCar,
                ownedCars: state.ownedCars,
                settings: state.settings,
                stats: state.stats,
                currentSession: state.currentSession
            };
            localStorage.setItem('pomoDriveState', JSON.stringify(data));
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('pomoDriveState');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.coins !== undefined) state.coins = data.coins;
                    if (data.selectedCar) state.selectedCar = data.selectedCar;
                    if (data.ownedCars) state.ownedCars = data.ownedCars;
                    if (data.settings) state.settings = { ...state.settings, ...data.settings };
                    if (data.stats) state.stats = { ...state.stats, ...data.stats };
                    if (data.currentSession) state.currentSession = data.currentSession;

                    // Reset daily stats if needed
                    const today = new Date().toDateString();
                    if (state.stats.lastResetDate !== today) {
                        state.stats.today = 0;
                        state.stats.lastResetDate = today;
                    }
                }
            } catch (e) {
                console.warn('Failed to load state:', e);
            }
        }

        function resetToDefaults() {
            state.settings = {
                workDuration: 25,
                shortBreakDuration: 5,
                longBreakDuration: 15,
                sessionsUntilLong: 4,
                autoStartBreaks: false,
                autoStartWork: false,
                soundEnabled: true,
                volume: 70,
                browserNotifications: false,
                theme: 'day'
            };

            initSettingsUI();
            setTheme('day');
            applySettings();
            showToast('Settings reset! ‚ú®');
        }

        function clearAllData() {
            if (confirm('Clear all data? This includes coins and cars! üò¢')) {
                localStorage.removeItem('pomoDriveState');

                state.coins = 0;
                state.selectedCar = 'pink';
                state.ownedCars = ['pink'];
                state.stats = { today: 0, totalCoins: 0, lastResetDate: new Date().toDateString() };
                state.currentSession = 1;

                resetToDefaults();
                updateCoinDisplay();
                updateStatsDisplay();
                updateSessionInfo();
                drawCar();

                showToast('All data cleared! üóëÔ∏è');
            }
        }

        // ===== Toast =====
        function showToast(message, duration = 3000) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            setTimeout(() => elements.toast.classList.remove('show'), duration);
        }

        // ===== Event Listeners =====
        function setupEventListeners() {
            elements.startBtn.addEventListener('click', startTimer);
            elements.pauseBtn.addEventListener('click', pauseTimer);
            elements.resetBtn.addEventListener('click', resetTimer);

            elements.shopBtn.addEventListener('click', openShop);
            elements.closeShopBtn.addEventListener('click', closeShop);
            elements.shopOverlay.addEventListener('click', closeShop);

            elements.settingsBtn.addEventListener('click', openSettings);
            elements.closeSettingsBtn.addEventListener('click', closeSettings);
            elements.settingsOverlay.addEventListener('click', closeSettings);

            [elements.workDuration, elements.shortBreakDuration, elements.longBreakDuration, elements.sessionsUntilLong].forEach(input => {
                input.addEventListener('change', applySettings);
            });

            elements.volumeSlider.addEventListener('input', () => {
                state.settings.volume = parseInt(elements.volumeSlider.value);
                saveState();
            });
            elements.volumeSlider.addEventListener('change', () => playSound('coin'));

            elements.autoStartBreaks.addEventListener('click', () => {
                elements.autoStartBreaks.classList.toggle('active');
                state.settings.autoStartBreaks = elements.autoStartBreaks.classList.contains('active');
                saveState();
            });

            elements.autoStartWork.addEventListener('click', () => {
                elements.autoStartWork.classList.toggle('active');
                state.settings.autoStartWork = elements.autoStartWork.classList.contains('active');
                saveState();
            });

            elements.soundEnabled.addEventListener('click', () => {
                elements.soundEnabled.classList.toggle('active');
                state.settings.soundEnabled = elements.soundEnabled.classList.contains('active');
                saveState();
            });

            elements.browserNotifications.addEventListener('click', async () => {
                if (!elements.browserNotifications.classList.contains('active')) {
                    const granted = await requestNotificationPermission();
                    if (granted) {
                        elements.browserNotifications.classList.add('active');
                        state.settings.browserNotifications = true;
                        showToast('Notifications enabled! üîî');
                    } else {
                        showToast('Permission denied üò¢');
                    }
                } else {
                    elements.browserNotifications.classList.remove('active');
                    state.settings.browserNotifications = false;
                }
                saveState();
            });

            elements.themeButtons.forEach(btn => {
                btn.addEventListener('click', () => setTheme(btn.dataset.theme));
            });

            elements.resetDefaults.addEventListener('click', resetToDefaults);
            elements.clearAllData.addEventListener('click', clearAllData);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (state.isRunning && !state.isPaused) pauseTimer();
                        else startTimer();
                        break;
                    case 'KeyR':
                        if (!e.ctrlKey && !e.metaKey) resetTimer();
                        break;
                    case 'Escape':
                        closeShop();
                        closeSettings();
                        break;
                }
            });

            // Resize handler
            window.addEventListener('resize', () => {
                drawAllLayers();
            });
        }

        // ===== Initialization =====
        function init() {
            loadState();
            setTheme(state.settings.theme);
            initSettingsUI();

            state.timeRemaining = state.settings.workDuration * 60;
            state.totalTime = state.settings.workDuration * 60;

            drawAllLayers();
            updateDisplay();
            updateSessionInfo();
            updateCoinDisplay();
            updateStatsDisplay();
            setupEventListeners();

            if (state.settings.browserNotifications && Notification.permission !== 'granted') {
                state.settings.browserNotifications = false;
                elements.browserNotifications.classList.remove('active');
            }
        }

        init();
    </script>
</body>
</html>
