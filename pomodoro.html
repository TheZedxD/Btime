<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pomo Drive ~ Chill & Focus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS Custom Properties - Vaporwave/Hello Kitty Theme ===== */
        :root {
            /* Vaporwave Pinks */
            --pink-light: #ffd6e0;
            --pink-main: #ff8fab;
            --pink-deep: #ff5c8d;
            --pink-dark: #c94277;

            /* Vaporwave Accents */
            --cyan: #7fefef;
            --cyan-dark: #4ecdc4;
            --purple: #c792ea;
            --purple-dark: #9b6dff;
            --peach: #ffb5a7;
            --mint: #b5ead7;
            --lavender: #e2d1f9;
            --yellow: #fff3b0;

            /* Sky Gradient Colors */
            --sky-top: #ff9a9e;
            --sky-mid: #fecfef;
            --sky-bottom: #ffdde1;

            /* Night Sky */
            --night-top: #2d1b4e;
            --night-mid: #4a2c7a;
            --night-bottom: #7b4b94;

            /* UI Colors */
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-border: rgba(255, 143, 171, 0.4);
            --text-primary: #5c4158;
            --text-secondary: #8b7086;
            --text-muted: #b8a5b3;

            /* Game Colors */
            --coin-gold: #ffd700;
            --coin-shine: #fff8dc;

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
        }

        [data-theme="night"] {
            --sky-top: var(--night-top);
            --sky-mid: var(--night-mid);
            --sky-bottom: var(--night-bottom);
            --card-bg: rgba(45, 27, 78, 0.95);
            --card-border: rgba(199, 146, 234, 0.4);
            --text-primary: #f0e6f5;
            --text-secondary: #c9b8d4;
            --text-muted: #8b7a96;
        }

        /* ===== Reset & Base ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-mid) 50%, var(--sky-bottom) 100%);
            transition: background var(--transition-slow);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== Pixel Font ===== */
        .pixel-font {
            font-family: 'Press Start 2P', monospace;
            letter-spacing: -1px;
        }

        /* ===== Game Container ===== */
        .game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 0.8s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* ===== Parallax Layers ===== */
        .parallax-layer {
            position: absolute;
            left: 0;
            width: 200%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* Stars Layer (Night only) */
        .stars-layer {
            top: 0;
            height: 50%;
            opacity: 0;
            transition: opacity var(--transition-slow);
        }

        [data-theme="night"] .stars-layer {
            opacity: 1;
        }

        /* Clouds Layer */
        .clouds-layer {
            top: 5%;
            height: 20%;
            animation: parallax-clouds 100s linear infinite;
        }

        /* Hills/Bubbles Layer */
        .hills-layer {
            bottom: 25%;
            height: 35%;
            animation: parallax-hills 60s linear infinite;
        }

        /* Buildings Layer */
        .buildings-layer {
            bottom: 18%;
            height: 30%;
            animation: parallax-buildings 35s linear infinite;
        }

        /* Ground Layer */
        .ground-layer {
            bottom: 0;
            height: 20%;
            width: 100%;
        }

        @keyframes parallax-clouds {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        @keyframes parallax-hills {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        @keyframes parallax-buildings {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        /* Pause animations when not driving */
        .game-container:not(.driving) .clouds-layer,
        .game-container:not(.driving) .hills-layer,
        .game-container:not(.driving) .buildings-layer {
            animation-play-state: paused;
        }

        /* ===== Celestial Body ===== */
        .celestial {
            position: absolute;
            top: 8%;
            right: 12%;
            width: 64px;
            height: 64px;
            transition: all var(--transition-slow);
        }

        /* ===== Car System ===== */
        .car-container {
            position: absolute;
            bottom: 14%;
            left: 15%;
            z-index: 50;
        }

        .car-wrapper {
            position: relative;
            width: 100px;
            height: 50px;
        }

        .car-body {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .car-wrapper.driving .car-body {
            animation: car-bounce 0.25s ease-in-out infinite;
        }

        @keyframes car-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        /* Wheels */
        .wheel {
            position: absolute;
            bottom: -2px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #5c4158;
            border: 3px solid #8b7a96;
        }

        .wheel-front { left: 12px; }
        .wheel-back { right: 12px; }

        .wheel-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #b8a5b3;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .wheel-spoke {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 100%;
            background: #8b7a96;
            transform-origin: center center;
        }

        .car-wrapper.driving .wheel {
            animation: wheel-spin 0.3s linear infinite;
        }

        @keyframes wheel-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Exhaust Particles */
        .exhaust-container {
            position: absolute;
            left: -30px;
            bottom: 5px;
            width: 40px;
            height: 30px;
            pointer-events: none;
            overflow: visible;
        }

        .exhaust-particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            will-change: transform, opacity;
        }

        /* ===== Floating Coins ===== */
        .floating-coins {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 60;
            overflow: hidden;
        }

        .floating-coin {
            position: absolute;
            font-size: 20px;
            animation: coin-float 1.5s ease-out forwards;
            will-change: transform, opacity;
        }

        @keyframes coin-float {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.3); }
        }

        /* ===== Main UI Card ===== */
        .ui-card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 3px solid var(--card-border);
            border-radius: 20px;
            padding: var(--space-lg);
            text-align: center;
            box-shadow:
                0 8px 32px rgba(255, 92, 141, 0.15),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            z-index: 100;
            width: 320px;
            max-width: 90vw;
            transition: all var(--transition-slow);
        }

        .ui-card::before {
            content: 'üéÄ';
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* ===== Top Bar ===== */
        .top-bar {
            position: absolute;
            top: var(--space-md);
            left: var(--space-md);
            right: var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 150;
        }

        .coin-display {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: var(--card-bg);
            padding: var(--space-sm) var(--space-md);
            border-radius: 50px;
            border: 2px solid var(--coin-gold);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.25);
        }

        .coin-icon {
            font-size: 18px;
            animation: coin-spin 2.5s ease-in-out infinite;
        }

        @keyframes coin-spin {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        .coin-count {
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            color: var(--text-primary);
            min-width: 24px;
        }

        .top-buttons {
            display: flex;
            gap: var(--space-sm);
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--card-border);
            background: var(--card-bg);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform var(--transition-fast), box-shadow var(--transition-medium);
        }

        .icon-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        /* ===== Mode Badge ===== */
        .mode-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-md);
            border-radius: 16px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: var(--space-xs);
        }

        .mode-badge.work {
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
            color: white;
        }

        .mode-badge.break {
            background: linear-gradient(135deg, var(--mint), var(--cyan-dark));
            color: var(--text-primary);
        }

        .session-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        /* ===== Timer Display ===== */
        .timer-wrapper {
            margin: var(--space-md) auto;
        }

        .timer-ring {
            width: 180px;
            height: 180px;
            margin: 0 auto;
            position: relative;
        }

        .timer-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-ring-bg {
            fill: none;
            stroke: var(--pink-light);
            stroke-width: 6;
        }

        .timer-ring-progress {
            fill: none;
            stroke: url(#timerGradient);
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .timer-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
        }

        .timer-time {
            font-family: 'Press Start 2P', monospace;
            font-size: 28px;
            color: var(--text-primary);
            text-shadow: 2px 2px 0 var(--pink-light);
            letter-spacing: -2px;
        }

        .timer-time.running {
            animation: timer-pulse 1.5s ease-in-out infinite;
        }

        @keyframes timer-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timer-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== Control Buttons ===== */
        .controls {
            display: flex;
            gap: var(--space-sm);
            justify-content: center;
            margin: var(--space-lg) 0 var(--space-md);
            flex-wrap: wrap;
        }

        .btn {
            font-family: 'Quicksand', sans-serif;
            font-size: 13px;
            font-weight: 600;
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            white-space: nowrap;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.25), transparent);
            border-radius: 50px 50px 0 0;
            pointer-events: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
            color: white;
            box-shadow: 0 4px 12px rgba(255, 92, 141, 0.35);
            min-width: 100px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 92, 141, 0.45);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: var(--lavender);
            color: var(--text-primary);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--purple);
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== Stats Row ===== */
        .stats-row {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            padding-top: var(--space-md);
            border-top: 2px dashed var(--pink-light);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            color: var(--pink-deep);
        }

        .stat-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: var(--space-xs);
        }

        /* ===== Panel Styles ===== */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(93, 65, 88, 0.6);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
            z-index: 200;
            backdrop-filter: blur(4px);
        }

        .panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .shop-panel, .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--card-bg);
            border: 3px solid var(--card-border);
            border-radius: 20px;
            padding: var(--space-lg);
            width: 380px;
            max-width: 92vw;
            max-height: 85vh;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
            z-index: 201;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25);
        }

        .shop-panel.open, .settings-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 2px dashed var(--pink-light);
        }

        .panel-title {
            font-family: 'Press Start 2P', monospace;
            font-size: 14px;
            color: var(--text-primary);
        }

        .close-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--pink-light);
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .close-btn:hover {
            background: var(--pink-main);
            color: white;
            transform: rotate(90deg);
        }

        /* Shop Sections */
        .shop-section {
            margin-bottom: var(--space-lg);
        }

        .shop-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-sm);
        }

        .shop-item {
            background: var(--lavender);
            border: 3px solid transparent;
            border-radius: 12px;
            padding: var(--space-sm);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .shop-item.selected {
            border-color: var(--pink-deep);
            background: var(--pink-light);
        }

        .shop-item.locked {
            opacity: 0.55;
        }

        .shop-item.locked::after {
            content: 'üîí';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
        }

        .item-preview {
            font-size: 24px;
            margin-bottom: 4px;
            line-height: 1;
        }

        .item-name {
            font-size: 8px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .item-price {
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--coin-gold);
        }

        .item-price.owned {
            color: var(--cyan-dark);
        }

        /* Settings Sections */
        .settings-section {
            margin-bottom: var(--space-md);
        }

        .settings-section-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--pink-light);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 12px;
            color: var(--text-primary);
        }

        .setting-input {
            width: 60px;
            padding: 6px 8px;
            border: 2px solid var(--pink-light);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            text-align: center;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--pink-main);
        }

        /* Toggle */
        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--lavender);
            border-radius: 13px;
            cursor: pointer;
            transition: background var(--transition-medium);
        }

        .toggle.active {
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: transform var(--transition-medium);
        }

        .toggle.active::after {
            transform: translateX(22px);
        }

        /* Slider */
        .setting-slider {
            -webkit-appearance: none;
            width: 90px;
            height: 6px;
            background: var(--lavender);
            border-radius: 3px;
            outline: none;
        }

        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(255, 92, 141, 0.4);
        }

        /* Theme Buttons */
        .theme-toggle {
            display: flex;
            gap: 6px;
        }

        .theme-btn {
            padding: 6px 12px;
            border: 2px solid var(--pink-light);
            border-radius: 8px;
            background: white;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .theme-btn.active {
            background: linear-gradient(135deg, var(--pink-main), var(--pink-deep));
            color: white;
            border-color: var(--pink-deep);
        }

        /* Settings Actions */
        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 2px dashed var(--pink-light);
        }

        .btn-danger {
            background: transparent;
            border: 2px solid var(--pink-deep);
            color: var(--pink-deep);
            box-shadow: none;
        }

        .btn-danger:hover {
            background: var(--pink-deep);
            color: white;
        }

        /* ===== Toast ===== */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(40px);
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 50px;
            border: 2px solid var(--pink-main);
            box-shadow: 0 6px 24px rgba(255, 92, 141, 0.25);
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-medium);
            z-index: 300;
            white-space: nowrap;
            max-width: 90vw;
            text-align: center;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            visibility: visible;
        }

        /* ===== Work Overlay ===== */
        .work-overlay {
            position: fixed;
            bottom: var(--space-md);
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: var(--space-sm) var(--space-md);
            border-radius: 16px;
            border: 2px solid var(--pink-light);
            font-size: 11px;
            color: var(--text-secondary);
            z-index: 90;
            opacity: 0;
            transition: opacity var(--transition-medium);
            pointer-events: none;
            white-space: nowrap;
        }

        .work-overlay.show {
            opacity: 1;
        }

        /* ===== Break Glow ===== */
        .break-glow {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: radial-gradient(ellipse at center, rgba(181, 234, 215, 0.15) 0%, transparent 60%);
            opacity: 0;
            transition: opacity var(--transition-slow);
            z-index: 5;
        }

        .break-glow.active {
            opacity: 1;
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 480px) {
            :root {
                --space-lg: 20px;
                --space-xl: 24px;
            }

            .ui-card {
                width: 300px;
                padding: var(--space-md);
            }

            .timer-ring {
                width: 150px;
                height: 150px;
            }

            .timer-time {
                font-size: 22px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 12px;
            }

            .controls {
                gap: 6px;
            }

            .car-wrapper {
                width: 80px;
                height: 40px;
            }

            .wheel {
                width: 14px;
                height: 14px;
            }

            .wheel-front { left: 8px; }
            .wheel-back { right: 8px; }

            .item-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-value {
                font-size: 14px;
            }

            .stats-row {
                gap: var(--space-lg);
            }
        }

        @media (max-width: 360px) {
            .ui-card {
                width: 280px;
            }

            .timer-ring {
                width: 130px;
                height: 130px;
            }

            .timer-time {
                font-size: 20px;
            }

            .panel-title {
                font-size: 12px;
            }
        }

        @media (min-width: 1200px) {
            .ui-card {
                width: 360px;
                padding: var(--space-xl);
            }

            .timer-ring {
                width: 200px;
                height: 200px;
            }

            .timer-time {
                font-size: 32px;
            }

            .car-wrapper {
                width: 120px;
                height: 60px;
            }

            .wheel {
                width: 22px;
                height: 22px;
            }
        }

        /* ===== Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--pink-light);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--pink-main);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--pink-deep);
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <!-- SVG Definitions -->
        <svg style="position: absolute; width: 0; height: 0;">
            <defs>
                <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#ff8fab"/>
                    <stop offset="100%" style="stop-color:#ff5c8d"/>
                </linearGradient>
                <linearGradient id="breakGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#b5ead7"/>
                    <stop offset="100%" style="stop-color:#4ecdc4"/>
                </linearGradient>
            </defs>
        </svg>

        <!-- Break Glow -->
        <div class="break-glow" id="breakGlow"></div>

        <!-- Parallax Layers -->
        <canvas class="parallax-layer stars-layer" id="starsCanvas"></canvas>
        <canvas class="parallax-layer clouds-layer" id="cloudsCanvas"></canvas>
        <canvas class="parallax-layer hills-layer" id="hillsCanvas"></canvas>
        <canvas class="parallax-layer buildings-layer" id="buildingsCanvas"></canvas>
        <canvas class="parallax-layer ground-layer" id="groundCanvas"></canvas>

        <!-- Celestial Body -->
        <canvas class="celestial" id="celestialCanvas" width="64" height="64"></canvas>

        <!-- Floating Coins -->
        <div class="floating-coins" id="floatingCoins"></div>

        <!-- Car -->
        <div class="car-container" id="carContainer">
            <div class="exhaust-container" id="exhaustContainer"></div>
            <div class="car-wrapper" id="carWrapper">
                <canvas class="car-body" id="carCanvas" width="100" height="50"></canvas>
                <div class="wheel wheel-front" id="wheelFront">
                    <div class="wheel-inner"></div>
                </div>
                <div class="wheel wheel-back" id="wheelBack">
                    <div class="wheel-inner"></div>
                </div>
            </div>
        </div>

        <!-- Top Bar -->
        <div class="top-bar">
            <div class="coin-display">
                <span class="coin-icon">ü™ô</span>
                <span class="coin-count pixel-font" id="coinCount">0</span>
            </div>
            <div class="top-buttons">
                <button class="icon-btn" id="shopBtn" title="Shop">üõí</button>
                <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Main UI Card -->
        <div class="ui-card">
            <div class="mode-badge work" id="modeBadge">Focus Time</div>
            <div class="session-info" id="sessionInfo">Session 1 of 4 üçÖ</div>

            <div class="timer-wrapper">
                <div class="timer-ring">
                    <svg viewBox="0 0 100 100">
                        <circle class="timer-ring-bg" cx="50" cy="50" r="45"/>
                        <circle class="timer-ring-progress" id="progressRing" cx="50" cy="50" r="45"/>
                    </svg>
                    <div class="timer-display">
                        <div class="timer-time pixel-font" id="timerDisplay">25:00</div>
                        <div class="timer-label" id="timerLabel">stay focused!</div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="startBtn">‚ñ∂ Start</button>
                <button class="btn btn-secondary" id="pauseBtn" disabled>‚è∏ Pause</button>
                <button class="btn btn-secondary" id="resetBtn">‚Ü∫ Reset</button>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="todayPomodoros">0</div>
                    <div class="stat-label">Today</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCoins">0</div>
                    <div class="stat-label">Total ü™ô</div>
                </div>
            </div>
        </div>

        <!-- Work Overlay -->
        <div class="work-overlay" id="workOverlay">
            üöó Driving... Focus on work! üí™
        </div>
    </div>

    <!-- Shop Overlay -->
    <div class="panel-overlay" id="shopOverlay"></div>

    <!-- Shop Panel -->
    <div class="shop-panel" id="shopPanel">
        <div class="panel-header">
            <h2 class="panel-title">üõí Shop</h2>
            <button class="close-btn" id="closeShopBtn">‚úï</button>
        </div>

        <div class="shop-section">
            <div class="shop-section-title">üöó Cars</div>
            <div class="item-grid" id="carGrid"></div>
        </div>

        <div class="shop-section">
            <div class="shop-section-title">üõû Wheels</div>
            <div class="item-grid" id="wheelGrid"></div>
        </div>

        <div class="shop-section">
            <div class="shop-section-title">üí° Earn Coins</div>
            <p style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;">
                Earn <strong>+1 coin</strong> every 3 seconds during breaks! ü™ô
            </p>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div class="panel-overlay" id="settingsOverlay"></div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="panel-header">
            <h2 class="panel-title">‚öôÔ∏è Settings</h2>
            <button class="close-btn" id="closeSettingsBtn">‚úï</button>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">‚è±Ô∏è Timer (min)</div>
            <div class="setting-item">
                <span class="setting-label">Work</span>
                <input type="number" class="setting-input" id="workDuration" min="1" max="60" value="25">
            </div>
            <div class="setting-item">
                <span class="setting-label">Short Break</span>
                <input type="number" class="setting-input" id="shortBreakDuration" min="1" max="60" value="5">
            </div>
            <div class="setting-item">
                <span class="setting-label">Long Break</span>
                <input type="number" class="setting-input" id="longBreakDuration" min="1" max="60" value="15">
            </div>
            <div class="setting-item">
                <span class="setting-label">Sessions</span>
                <input type="number" class="setting-input" id="sessionsUntilLong" min="1" max="10" value="4">
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">üîÑ Auto-Start</div>
            <div class="setting-item">
                <span class="setting-label">Breaks</span>
                <div class="toggle" id="autoStartBreaks"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Work</span>
                <div class="toggle" id="autoStartWork"></div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">üîî Sound</div>
            <div class="setting-item">
                <span class="setting-label">Enabled</span>
                <div class="toggle active" id="soundEnabled"></div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Volume</span>
                <input type="range" class="setting-slider" id="volumeSlider" min="0" max="100" value="70">
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title">üé® Theme</div>
            <div class="setting-item">
                <span class="setting-label">Mode</span>
                <div class="theme-toggle">
                    <button class="theme-btn active" data-theme="day">‚òÄÔ∏è</button>
                    <button class="theme-btn" data-theme="night">üåô</button>
                </div>
            </div>
        </div>

        <div class="settings-actions">
            <button class="btn btn-secondary" id="resetDefaults">Reset Defaults</button>
            <button class="btn btn-danger" id="clearAllData">Clear All Data</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== Application State =====
        const state = {
            isRunning: false,
            isPaused: false,
            timeRemaining: 25 * 60,
            totalTime: 25 * 60,
            currentMode: 'work',
            currentSession: 1,
            timerInterval: null,
            coinInterval: null,
            exhaustInterval: null,
            particlePool: [],
            activeParticles: [],

            // Game state
            coins: 0,
            selectedCar: 'pink',
            selectedWheel: 'standard',
            ownedCars: ['pink'],
            ownedWheels: ['standard'],

            // Settings
            settings: {
                workDuration: 25,
                shortBreakDuration: 5,
                longBreakDuration: 15,
                sessionsUntilLong: 4,
                autoStartBreaks: false,
                autoStartWork: false,
                soundEnabled: true,
                volume: 70,
                theme: 'day'
            },

            stats: {
                today: 0,
                totalCoins: 0,
                lastResetDate: null
            }
        };

        // ===== Item Definitions =====
        const CARS = [
            { id: 'pink', name: 'Pinky', price: 0, emoji: 'üöó', color: '#ff8fab' },
            { id: 'lavender', name: 'Dreamy', price: 50, emoji: 'üöô', color: '#c792ea' },
            { id: 'mint', name: 'Minty', price: 100, emoji: 'üöï', color: '#b5ead7' },
            { id: 'peach', name: 'Peachy', price: 150, emoji: 'üõª', color: '#ffb5a7' },
            { id: 'cyan', name: 'Ocean', price: 200, emoji: 'üöê', color: '#7fefef' },
            { id: 'gold', name: 'Luxe', price: 500, emoji: 'üèéÔ∏è', color: '#ffd700' }
        ];

        const WHEELS = [
            { id: 'standard', name: 'Standard', price: 0, color: '#5c4158', accent: '#8b7a96' },
            { id: 'pink', name: 'Pink', price: 30, color: '#ff8fab', accent: '#ffd6e0' },
            { id: 'gold', name: 'Gold', price: 80, color: '#ffd700', accent: '#fff3b0' },
            { id: 'rainbow', name: 'Rainbow', price: 150, color: '#c792ea', accent: '#7fefef' },
            { id: 'dark', name: 'Dark', price: 100, color: '#2d1b4e', accent: '#4a2c7a' },
            { id: 'white', name: 'White', price: 60, color: '#f0e6f5', accent: '#ffffff' }
        ];

        // ===== DOM Elements =====
        const el = {
            gameContainer: document.getElementById('gameContainer'),
            timerDisplay: document.getElementById('timerDisplay'),
            timerLabel: document.getElementById('timerLabel'),
            modeBadge: document.getElementById('modeBadge'),
            sessionInfo: document.getElementById('sessionInfo'),
            progressRing: document.getElementById('progressRing'),
            startBtn: document.getElementById('startBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            resetBtn: document.getElementById('resetBtn'),
            todayPomodoros: document.getElementById('todayPomodoros'),
            totalCoins: document.getElementById('totalCoins'),
            coinCount: document.getElementById('coinCount'),
            breakGlow: document.getElementById('breakGlow'),
            workOverlay: document.getElementById('workOverlay'),
            floatingCoins: document.getElementById('floatingCoins'),
            exhaustContainer: document.getElementById('exhaustContainer'),
            carWrapper: document.getElementById('carWrapper'),
            carCanvas: document.getElementById('carCanvas'),
            wheelFront: document.getElementById('wheelFront'),
            wheelBack: document.getElementById('wheelBack'),

            // Canvases
            starsCanvas: document.getElementById('starsCanvas'),
            cloudsCanvas: document.getElementById('cloudsCanvas'),
            hillsCanvas: document.getElementById('hillsCanvas'),
            buildingsCanvas: document.getElementById('buildingsCanvas'),
            groundCanvas: document.getElementById('groundCanvas'),
            celestialCanvas: document.getElementById('celestialCanvas'),

            // Panels
            shopBtn: document.getElementById('shopBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            shopPanel: document.getElementById('shopPanel'),
            shopOverlay: document.getElementById('shopOverlay'),
            closeShopBtn: document.getElementById('closeShopBtn'),
            settingsPanel: document.getElementById('settingsPanel'),
            settingsOverlay: document.getElementById('settingsOverlay'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            carGrid: document.getElementById('carGrid'),
            wheelGrid: document.getElementById('wheelGrid'),
            toast: document.getElementById('toast'),

            // Settings
            workDuration: document.getElementById('workDuration'),
            shortBreakDuration: document.getElementById('shortBreakDuration'),
            longBreakDuration: document.getElementById('longBreakDuration'),
            sessionsUntilLong: document.getElementById('sessionsUntilLong'),
            autoStartBreaks: document.getElementById('autoStartBreaks'),
            autoStartWork: document.getElementById('autoStartWork'),
            soundEnabled: document.getElementById('soundEnabled'),
            volumeSlider: document.getElementById('volumeSlider'),
            themeButtons: document.querySelectorAll('.theme-btn'),
            resetDefaults: document.getElementById('resetDefaults'),
            clearAllData: document.getElementById('clearAllData')
        };

        // ===== Particle System with Object Pooling =====
        const MAX_PARTICLES = 20;

        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'exhaust-particle';
            particle.style.display = 'none';
            return particle;
        }

        function initParticlePool() {
            for (let i = 0; i < MAX_PARTICLES; i++) {
                const particle = createParticle();
                el.exhaustContainer.appendChild(particle);
                state.particlePool.push(particle);
            }
        }

        function getParticle() {
            if (state.particlePool.length > 0) {
                return state.particlePool.pop();
            }
            return null;
        }

        function returnParticle(particle) {
            particle.style.display = 'none';
            particle.style.transform = '';
            particle.style.opacity = '';
            const idx = state.activeParticles.indexOf(particle);
            if (idx > -1) state.activeParticles.splice(idx, 1);
            state.particlePool.push(particle);
        }

        function spawnExhaustParticle() {
            const particle = getParticle();
            if (!particle) return;

            const size = 4 + Math.random() * 6;
            const startX = Math.random() * 10;
            const startY = 10 + Math.random() * 10;

            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            particle.style.left = startX + 'px';
            particle.style.top = startY + 'px';
            particle.style.display = 'block';
            particle.style.opacity = '0.6';

            state.activeParticles.push(particle);

            let progress = 0;
            const duration = 600 + Math.random() * 400;
            const startTime = performance.now();
            const targetX = -30 - Math.random() * 20;
            const targetY = startY - 10 + Math.random() * 20;

            function animate(currentTime) {
                progress = (currentTime - startTime) / duration;

                if (progress >= 1) {
                    returnParticle(particle);
                    return;
                }

                const easeOut = 1 - Math.pow(1 - progress, 3);
                const x = startX + (targetX - startX) * easeOut;
                const y = startY + (targetY - startY) * easeOut;
                const scale = 1 + progress * 0.5;
                const opacity = 0.6 * (1 - progress);

                particle.style.transform = `translate(${x - startX}px, ${y - startY}px) scale(${scale})`;
                particle.style.opacity = opacity;

                requestAnimationFrame(animate);
            }

            requestAnimationFrame(animate);
        }

        function startExhaust() {
            if (state.exhaustInterval) return;
            state.exhaustInterval = setInterval(spawnExhaustParticle, 150);
        }

        function stopExhaust() {
            if (state.exhaustInterval) {
                clearInterval(state.exhaustInterval);
                state.exhaustInterval = null;
            }
        }

        // ===== Drawing Functions =====
        function drawStars(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 2;
            canvas.height = window.innerHeight * 0.5;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#ffffff';
            for (let i = 0; i < 80; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() > 0.8 ? 3 : 2;
                ctx.fillRect(x, y, size, size);
            }

            ctx.fillStyle = '#fff3b0';
            for (let i = 0; i < 15; i++) {
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 4, 4);
            }
        }

        function drawClouds(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 2;
            canvas.height = window.innerHeight * 0.2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.imageSmoothingEnabled = false;

            const isNight = state.settings.theme === 'night';
            const cloudColor = isNight ? 'rgba(199, 146, 234, 0.5)' : 'rgba(255, 255, 255, 0.9)';

            const clouds = [];
            for (let i = 0; i < 12; i++) {
                clouds.push({
                    x: i * (canvas.width / 6) + Math.random() * 100,
                    y: 20 + Math.random() * (canvas.height - 60),
                    scale: 0.8 + Math.random() * 0.6
                });
            }

            clouds.forEach(cloud => {
                drawPixelCloud(ctx, cloud.x, cloud.y, cloud.scale, cloudColor);
            });
        }

        function drawPixelCloud(ctx, x, y, scale, color) {
            ctx.fillStyle = color;
            const ps = 6 * scale;

            // Fluffy cloud shape using circles/rounded pixels
            const pattern = [
                [0,0,1,1,1,0,0,0,1,1,0,0],
                [0,1,1,1,1,1,1,1,1,1,1,0],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [1,1,1,1,1,1,1,1,1,1,1,1],
                [0,1,1,1,1,1,1,1,1,1,1,0],
                [0,0,1,1,1,1,1,1,1,1,0,0],
            ];

            pattern.forEach((row, py) => {
                row.forEach((pixel, px) => {
                    if (pixel) {
                        ctx.beginPath();
                        ctx.arc(x + px * ps + ps/2, y + py * ps + ps/2, ps/2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            });
        }

        function drawHills(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 2;
            canvas.height = window.innerHeight * 0.35;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const isNight = state.settings.theme === 'night';

            // Draw soft rounded hills (bubbles) instead of triangles
            const hills = [
                { colors: isNight ? ['#7b4b94', '#9b6dff'] : ['#e2d1f9', '#c792ea'], yOffset: 0.3 },
                { colors: isNight ? ['#4a2c7a', '#7b4b94'] : ['#ffd6e0', '#ffb5a7'], yOffset: 0.5 }
            ];

            hills.forEach((layer, layerIdx) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, layer.colors[0]);
                gradient.addColorStop(1, layer.colors[1]);
                ctx.fillStyle = gradient;

                for (let i = 0; i < 20; i++) {
                    const x = i * (canvas.width / 10) - 50 + (layerIdx * 80);
                    const radius = 80 + Math.random() * 60;
                    const y = canvas.height * layer.yOffset + Math.random() * 40;

                    ctx.beginPath();
                    ctx.arc(x, y + radius, radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // Add floating bubbles/circles decoration
            const bubbleColors = isNight
                ? ['rgba(155, 109, 255, 0.3)', 'rgba(199, 146, 234, 0.3)', 'rgba(127, 239, 239, 0.2)']
                : ['rgba(255, 214, 224, 0.5)', 'rgba(199, 146, 234, 0.4)', 'rgba(181, 234, 215, 0.4)'];

            for (let i = 0; i < 25; i++) {
                ctx.fillStyle = bubbleColors[Math.floor(Math.random() * bubbleColors.length)];
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height * 0.7;
                const r = 10 + Math.random() * 30;

                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawBuildings(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth * 2;
            canvas.height = window.innerHeight * 0.3;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.imageSmoothingEnabled = false;

            const isNight = state.settings.theme === 'night';
            const colors = isNight
                ? ['#2d1b4e', '#4a2c7a', '#7b4b94', '#9b6dff']
                : ['#ffd6e0', '#ffb5a7', '#e2d1f9', '#b5ead7'];
            const windowOn = isNight ? '#fff3b0' : '#7fefef';
            const windowOff = isNight ? '#4a2c7a' : '#c792ea';

            for (let i = 0; i < 35; i++) {
                const x = i * 90 + Math.random() * 30;
                const w = 50 + Math.random() * 35;
                const h = 60 + Math.random() * 80;
                const color = colors[Math.floor(Math.random() * colors.length)];

                // Building body
                ctx.fillStyle = color;
                ctx.fillRect(x, canvas.height - h, w, h);

                // Rounded top
                ctx.beginPath();
                ctx.arc(x + w/2, canvas.height - h, w/2, Math.PI, 0);
                ctx.fill();

                // Windows
                for (let wy = 15; wy < h - 10; wy += 18) {
                    for (let wx = 8; wx < w - 8; wx += 14) {
                        ctx.fillStyle = Math.random() > 0.35 ? windowOn : windowOff;
                        ctx.fillRect(x + wx, canvas.height - h + wy, 6, 10);
                    }
                }
            }
        }

        function drawGround(canvas) {
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight * 0.2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const isNight = state.settings.theme === 'night';

            // Grass
            ctx.fillStyle = isNight ? '#1d3d3a' : '#b5ead7';
            ctx.fillRect(0, 0, canvas.width, canvas.height * 0.35);

            // Road
            ctx.fillStyle = isNight ? '#2d1b4e' : '#e2d1f9';
            ctx.fillRect(0, canvas.height * 0.25, canvas.width, canvas.height * 0.45);

            // Road lines
            ctx.fillStyle = isNight ? '#9b6dff' : '#ffffff';
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.fillRect(x, canvas.height * 0.45, 25, 4);
            }

            // Sidewalk
            ctx.fillStyle = isNight ? '#4a2c7a' : '#ffd6e0';
            ctx.fillRect(0, canvas.height * 0.65, canvas.width, canvas.height * 0.35);

            // Little flowers
            const flowerColors = ['#ff8fab', '#fff3b0', '#7fefef', '#c792ea'];
            for (let i = 0; i < 20; i++) {
                ctx.fillStyle = flowerColors[Math.floor(Math.random() * flowerColors.length)];
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height * 0.3, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawCelestial(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 64, 64);
            ctx.imageSmoothingEnabled = false;

            if (state.settings.theme === 'night') {
                // Moon
                ctx.fillStyle = '#fff3b0';
                ctx.beginPath();
                ctx.arc(32, 32, 20, 0, Math.PI * 2);
                ctx.fill();

                // Moon shadow
                ctx.fillStyle = state.settings.theme === 'night' ? '#4a2c7a' : '#fecfef';
                ctx.beginPath();
                ctx.arc(40, 28, 16, 0, Math.PI * 2);
                ctx.fill();
            } else {
                // Sun rays
                ctx.fillStyle = '#fff3b0';
                for (let i = 0; i < 8; i++) {
                    ctx.save();
                    ctx.translate(32, 32);
                    ctx.rotate((i * Math.PI) / 4);
                    ctx.fillRect(-2, -28, 4, 10);
                    ctx.restore();
                }

                // Sun body
                ctx.fillStyle = '#ffd700';
                ctx.beginPath();
                ctx.arc(32, 32, 16, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawCar() {
            const canvas = el.carCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 100, 50);
            ctx.imageSmoothingEnabled = false;

            const car = CARS.find(c => c.id === state.selectedCar) || CARS[0];
            const color = car.color;

            // Car body
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(5, 22, 90, 20, 4);
            ctx.fill();

            // Car top
            ctx.beginPath();
            ctx.roundRect(20, 8, 55, 18, [8, 8, 0, 0]);
            ctx.fill();

            // Windows
            ctx.fillStyle = '#7fefef';
            ctx.beginPath();
            ctx.roundRect(24, 11, 22, 12, 3);
            ctx.fill();
            ctx.beginPath();
            ctx.roundRect(50, 11, 22, 12, 3);
            ctx.fill();

            // Window shine
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.fillRect(26, 13, 3, 8);
            ctx.fillRect(52, 13, 3, 8);

            // Headlight
            ctx.fillStyle = '#fff3b0';
            ctx.beginPath();
            ctx.arc(92, 30, 4, 0, Math.PI * 2);
            ctx.fill();

            // Tail light
            ctx.fillStyle = '#ff5c8d';
            ctx.beginPath();
            ctx.arc(8, 30, 3, 0, Math.PI * 2);
            ctx.fill();

            // Cute face
            ctx.fillStyle = '#5c4158';
            ctx.fillRect(32, 15, 3, 3);
            ctx.fillRect(42, 15, 3, 3);

            // Blush
            ctx.fillStyle = '#ff8fab';
            ctx.beginPath();
            ctx.arc(29, 19, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(48, 19, 2, 0, Math.PI * 2);
            ctx.fill();

            // Bow
            ctx.fillStyle = '#ff5c8d';
            ctx.beginPath();
            ctx.arc(52, 6, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(58, 6, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillRect(53, 4, 4, 5);
        }

        function updateWheels() {
            const wheel = WHEELS.find(w => w.id === state.selectedWheel) || WHEELS[0];
            el.wheelFront.style.background = wheel.color;
            el.wheelFront.style.borderColor = wheel.accent;
            el.wheelBack.style.background = wheel.color;
            el.wheelBack.style.borderColor = wheel.accent;
        }

        function drawAllLayers() {
            drawStars(el.starsCanvas);
            drawClouds(el.cloudsCanvas);
            drawHills(el.hillsCanvas);
            drawBuildings(el.buildingsCanvas);
            drawGround(el.groundCanvas);
            drawCelestial(el.celestialCanvas);
            drawCar();
            updateWheels();
        }

        // ===== Audio =====
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            return audioCtx;
        }

        function playSound(type) {
            if (!state.settings.soundEnabled) return;
            try {
                const ctx = initAudio();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);

                const vol = state.settings.volume / 100 * 0.15;
                gain.gain.setValueAtTime(vol, ctx.currentTime);

                if (type === 'complete') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(523, ctx.currentTime);
                    osc.frequency.setValueAtTime(659, ctx.currentTime + 0.1);
                    osc.frequency.setValueAtTime(784, ctx.currentTime + 0.2);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.4);
                } else if (type === 'coin') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(988, ctx.currentTime);
                    osc.frequency.setValueAtTime(1319, ctx.currentTime + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.12);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.12);
                }
            } catch (e) {}
        }

        // ===== Timer =====
        const ringCircumference = 2 * Math.PI * 45;
        el.progressRing.style.strokeDasharray = ringCircumference;

        function updateProgressRing() {
            const progress = state.timeRemaining / state.totalTime;
            el.progressRing.style.strokeDashoffset = ringCircumference * (1 - progress);
            el.progressRing.style.stroke = state.currentMode === 'work' ? 'url(#timerGradient)' : 'url(#breakGradient)';
        }

        function formatTime(s) {
            return `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            el.timerDisplay.textContent = formatTime(state.timeRemaining);
            updateProgressRing();
            document.title = `${formatTime(state.timeRemaining)} - Pomo Drive`;
        }

        function setMode(mode) {
            state.currentMode = mode;
            if (mode === 'work') {
                el.modeBadge.className = 'mode-badge work';
                el.modeBadge.textContent = 'Focus Time';
                el.timerLabel.textContent = 'stay focused!';
                state.totalTime = state.settings.workDuration * 60;
                el.breakGlow.classList.remove('active');
                stopCoinGeneration();
            } else {
                el.modeBadge.className = 'mode-badge break';
                el.modeBadge.textContent = mode === 'shortBreak' ? 'Short Break' : 'Long Break';
                el.timerLabel.textContent = 'relax & earn coins!';
                state.totalTime = mode === 'shortBreak' ? state.settings.shortBreakDuration * 60 : state.settings.longBreakDuration * 60;
                el.breakGlow.classList.add('active');
            }
            state.timeRemaining = state.totalTime;
            updateDisplay();
        }

        function updateSessionInfo() {
            el.sessionInfo.textContent = `Session ${state.currentSession} of ${state.settings.sessionsUntilLong} üçÖ`;
        }

        function startTimer() {
            if (state.isRunning && !state.isPaused) return;
            initAudio();
            state.isRunning = true;
            state.isPaused = false;

            el.startBtn.textContent = 'üöó Driving...';
            el.startBtn.disabled = true;
            el.pauseBtn.disabled = false;
            el.timerDisplay.classList.add('running');
            el.gameContainer.classList.add('driving');
            el.carWrapper.classList.add('driving');

            if (state.currentMode === 'work') {
                el.workOverlay.classList.add('show');
            } else {
                startCoinGeneration();
            }

            startExhaust();

            state.timerInterval = setInterval(() => {
                state.timeRemaining--;
                updateDisplay();
                if (state.timeRemaining <= 0) timerComplete();
            }, 1000);
        }

        function pauseTimer() {
            if (!state.isRunning) return;
            state.isPaused = true;
            clearInterval(state.timerInterval);
            stopCoinGeneration();
            stopExhaust();

            el.startBtn.textContent = '‚ñ∂ Resume';
            el.startBtn.disabled = false;
            el.pauseBtn.disabled = true;
            el.timerDisplay.classList.remove('running');
            el.gameContainer.classList.remove('driving');
            el.carWrapper.classList.remove('driving');
            el.workOverlay.classList.remove('show');
        }

        function resetTimer() {
            clearInterval(state.timerInterval);
            stopCoinGeneration();
            stopExhaust();
            state.isRunning = false;
            state.isPaused = false;

            setMode(state.currentMode);

            el.startBtn.textContent = '‚ñ∂ Start';
            el.startBtn.disabled = false;
            el.pauseBtn.disabled = true;
            el.timerDisplay.classList.remove('running');
            el.gameContainer.classList.remove('driving');
            el.carWrapper.classList.remove('driving');
            el.workOverlay.classList.remove('show');
        }

        function timerComplete() {
            clearInterval(state.timerInterval);
            stopCoinGeneration();
            stopExhaust();
            state.isRunning = false;
            state.isPaused = false;

            el.timerDisplay.classList.remove('running');
            el.gameContainer.classList.remove('driving');
            el.carWrapper.classList.remove('driving');
            el.workOverlay.classList.remove('show');

            if (state.currentMode === 'work') {
                state.stats.today++;
                updateStatsDisplay();
                playSound('complete');
                showToast('üéâ Session complete!');

                if (state.currentSession >= state.settings.sessionsUntilLong) {
                    setMode('longBreak');
                    state.currentSession = 1;
                } else {
                    setMode('shortBreak');
                    state.currentSession++;
                }
                updateSessionInfo();

                if (state.settings.autoStartBreaks) {
                    setTimeout(() => { startTimer(); startCoinGeneration(); }, 1000);
                } else {
                    el.startBtn.textContent = '‚ñ∂ Start Break';
                    el.startBtn.disabled = false;
                }
            } else {
                playSound('complete');
                showToast('‚òï Break complete!');
                setMode('work');

                if (state.settings.autoStartWork) {
                    setTimeout(startTimer, 1000);
                } else {
                    el.startBtn.textContent = '‚ñ∂ Start';
                    el.startBtn.disabled = false;
                }
            }
            el.pauseBtn.disabled = true;
            saveState();
        }

        // ===== Coins =====
        function startCoinGeneration() {
            if (state.coinInterval) return;
            state.coinInterval = setInterval(() => {
                if (state.currentMode !== 'work' && state.isRunning && !state.isPaused) {
                    addCoins(1);
                    createFloatingCoin();
                }
            }, 3000);
        }

        function stopCoinGeneration() {
            if (state.coinInterval) {
                clearInterval(state.coinInterval);
                state.coinInterval = null;
            }
        }

        function addCoins(n) {
            state.coins += n;
            state.stats.totalCoins += n;
            updateCoinDisplay();
            playSound('coin');
            saveState();
        }

        function updateCoinDisplay() {
            el.coinCount.textContent = state.coins;
            el.totalCoins.textContent = state.stats.totalCoins;
        }

        function createFloatingCoin() {
            const coin = document.createElement('div');
            coin.className = 'floating-coin';
            coin.textContent = 'ü™ô';
            coin.style.left = `${15 + Math.random() * 15}%`;
            coin.style.bottom = '18%';
            el.floatingCoins.appendChild(coin);
            setTimeout(() => coin.remove(), 1500);
        }

        // ===== Shop =====
        function populateShop() {
            el.carGrid.innerHTML = '';
            CARS.forEach(car => {
                const owned = state.ownedCars.includes(car.id);
                const selected = state.selectedCar === car.id;
                const canAfford = state.coins >= car.price;

                const div = document.createElement('div');
                div.className = `shop-item ${selected ? 'selected' : ''} ${!owned && !canAfford ? 'locked' : ''}`;
                div.innerHTML = `
                    <div class="item-preview">${car.emoji}</div>
                    <div class="item-name">${car.name}</div>
                    <div class="item-price ${owned ? 'owned' : ''}">${owned ? '‚úì' : 'ü™ô' + car.price}</div>
                `;
                div.onclick = () => {
                    if (owned) selectCar(car.id);
                    else if (canAfford) buyCar(car);
                    else showToast(`Need ${car.price - state.coins} more coins!`);
                };
                el.carGrid.appendChild(div);
            });

            el.wheelGrid.innerHTML = '';
            WHEELS.forEach(wheel => {
                const owned = state.ownedWheels.includes(wheel.id);
                const selected = state.selectedWheel === wheel.id;
                const canAfford = state.coins >= wheel.price;

                const div = document.createElement('div');
                div.className = `shop-item ${selected ? 'selected' : ''} ${!owned && !canAfford ? 'locked' : ''}`;
                div.innerHTML = `
                    <div class="item-preview" style="width:24px;height:24px;border-radius:50%;background:${wheel.color};border:3px solid ${wheel.accent};margin:0 auto 4px;"></div>
                    <div class="item-name">${wheel.name}</div>
                    <div class="item-price ${owned ? 'owned' : ''}">${owned ? '‚úì' : 'ü™ô' + wheel.price}</div>
                `;
                div.onclick = () => {
                    if (owned) selectWheel(wheel.id);
                    else if (canAfford) buyWheel(wheel);
                    else showToast(`Need ${wheel.price - state.coins} more coins!`);
                };
                el.wheelGrid.appendChild(div);
            });
        }

        function selectCar(id) {
            state.selectedCar = id;
            drawCar();
            populateShop();
            saveState();
            showToast(`Selected ${CARS.find(c => c.id === id).name}!`);
        }

        function buyCar(car) {
            state.coins -= car.price;
            state.ownedCars.push(car.id);
            selectCar(car.id);
            updateCoinDisplay();
            showToast(`Bought ${car.name}! üéâ`);
        }

        function selectWheel(id) {
            state.selectedWheel = id;
            updateWheels();
            populateShop();
            saveState();
            showToast(`Selected ${WHEELS.find(w => w.id === id).name} wheels!`);
        }

        function buyWheel(wheel) {
            state.coins -= wheel.price;
            state.ownedWheels.push(wheel.id);
            selectWheel(wheel.id);
            updateCoinDisplay();
            showToast(`Bought ${wheel.name} wheels! üéâ`);
        }

        // ===== Panels =====
        function openShop() {
            if (state.currentMode === 'work' && state.isRunning && !state.isPaused) {
                showToast('Finish work first! üí™');
                return;
            }
            populateShop();
            el.shopPanel.classList.add('open');
            el.shopOverlay.classList.add('open');
        }

        function closeShop() {
            el.shopPanel.classList.remove('open');
            el.shopOverlay.classList.remove('open');
        }

        function openSettings() {
            if (state.currentMode === 'work' && state.isRunning && !state.isPaused) {
                showToast('Finish work first! üí™');
                return;
            }
            el.settingsPanel.classList.add('open');
            el.settingsOverlay.classList.add('open');
        }

        function closeSettings() {
            el.settingsPanel.classList.remove('open');
            el.settingsOverlay.classList.remove('open');
        }

        // ===== Settings =====
        function applySettings() {
            state.settings.workDuration = Math.max(1, Math.min(60, parseInt(el.workDuration.value) || 25));
            state.settings.shortBreakDuration = Math.max(1, Math.min(60, parseInt(el.shortBreakDuration.value) || 5));
            state.settings.longBreakDuration = Math.max(1, Math.min(60, parseInt(el.longBreakDuration.value) || 15));
            state.settings.sessionsUntilLong = Math.max(1, Math.min(10, parseInt(el.sessionsUntilLong.value) || 4));

            el.workDuration.value = state.settings.workDuration;
            el.shortBreakDuration.value = state.settings.shortBreakDuration;
            el.longBreakDuration.value = state.settings.longBreakDuration;
            el.sessionsUntilLong.value = state.settings.sessionsUntilLong;

            state.settings.volume = parseInt(el.volumeSlider.value);
            updateSessionInfo();

            if (!state.isRunning) setMode(state.currentMode);
            saveState();
        }

        function initSettingsUI() {
            el.workDuration.value = state.settings.workDuration;
            el.shortBreakDuration.value = state.settings.shortBreakDuration;
            el.longBreakDuration.value = state.settings.longBreakDuration;
            el.sessionsUntilLong.value = state.settings.sessionsUntilLong;
            el.volumeSlider.value = state.settings.volume;

            if (state.settings.autoStartBreaks) el.autoStartBreaks.classList.add('active');
            if (state.settings.autoStartWork) el.autoStartWork.classList.add('active');
            if (state.settings.soundEnabled) el.soundEnabled.classList.add('active');

            el.themeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.theme === state.settings.theme));
        }

        function setTheme(theme) {
            state.settings.theme = theme;
            document.documentElement.setAttribute('data-theme', theme === 'day' ? '' : 'night');
            el.themeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.theme === theme));
            drawAllLayers();
            saveState();
        }

        function updateStatsDisplay() {
            const today = new Date().toDateString();
            if (state.stats.lastResetDate !== today) {
                state.stats.today = 0;
                state.stats.lastResetDate = today;
            }
            el.todayPomodoros.textContent = state.stats.today;
            el.totalCoins.textContent = state.stats.totalCoins;
        }

        // ===== Storage =====
        function saveState() {
            localStorage.setItem('pomoDriveState', JSON.stringify({
                coins: state.coins,
                selectedCar: state.selectedCar,
                selectedWheel: state.selectedWheel,
                ownedCars: state.ownedCars,
                ownedWheels: state.ownedWheels,
                settings: state.settings,
                stats: state.stats,
                currentSession: state.currentSession
            }));
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('pomoDriveState');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.coins !== undefined) state.coins = data.coins;
                    if (data.selectedCar) state.selectedCar = data.selectedCar;
                    if (data.selectedWheel) state.selectedWheel = data.selectedWheel;
                    if (data.ownedCars) state.ownedCars = data.ownedCars;
                    if (data.ownedWheels) state.ownedWheels = data.ownedWheels;
                    if (data.settings) state.settings = { ...state.settings, ...data.settings };
                    if (data.stats) state.stats = { ...state.stats, ...data.stats };
                    if (data.currentSession) state.currentSession = data.currentSession;

                    const today = new Date().toDateString();
                    if (state.stats.lastResetDate !== today) {
                        state.stats.today = 0;
                        state.stats.lastResetDate = today;
                    }
                }
            } catch (e) {}
        }

        function resetToDefaults() {
            state.settings = {
                workDuration: 25, shortBreakDuration: 5, longBreakDuration: 15,
                sessionsUntilLong: 4, autoStartBreaks: false, autoStartWork: false,
                soundEnabled: true, volume: 70, theme: 'day'
            };
            initSettingsUI();
            setTheme('day');
            applySettings();
            showToast('Settings reset! ‚ú®');
        }

        function clearAllData() {
            if (confirm('Clear all data including coins?')) {
                localStorage.removeItem('pomoDriveState');
                state.coins = 0;
                state.selectedCar = 'pink';
                state.selectedWheel = 'standard';
                state.ownedCars = ['pink'];
                state.ownedWheels = ['standard'];
                state.stats = { today: 0, totalCoins: 0, lastResetDate: new Date().toDateString() };
                state.currentSession = 1;
                resetToDefaults();
                updateCoinDisplay();
                updateStatsDisplay();
                updateSessionInfo();
                drawCar();
                updateWheels();
                showToast('All data cleared! üóëÔ∏è');
            }
        }

        // ===== Toast =====
        function showToast(msg, dur = 2500) {
            el.toast.textContent = msg;
            el.toast.classList.add('show');
            setTimeout(() => el.toast.classList.remove('show'), dur);
        }

        // ===== Events =====
        function setupEvents() {
            el.startBtn.onclick = startTimer;
            el.pauseBtn.onclick = pauseTimer;
            el.resetBtn.onclick = resetTimer;

            el.shopBtn.onclick = openShop;
            el.closeShopBtn.onclick = closeShop;
            el.shopOverlay.onclick = closeShop;

            el.settingsBtn.onclick = openSettings;
            el.closeSettingsBtn.onclick = closeSettings;
            el.settingsOverlay.onclick = closeSettings;

            [el.workDuration, el.shortBreakDuration, el.longBreakDuration, el.sessionsUntilLong].forEach(input => {
                input.onchange = applySettings;
            });

            el.volumeSlider.oninput = () => { state.settings.volume = parseInt(el.volumeSlider.value); saveState(); };
            el.volumeSlider.onchange = () => playSound('coin');

            el.autoStartBreaks.onclick = () => {
                el.autoStartBreaks.classList.toggle('active');
                state.settings.autoStartBreaks = el.autoStartBreaks.classList.contains('active');
                saveState();
            };

            el.autoStartWork.onclick = () => {
                el.autoStartWork.classList.toggle('active');
                state.settings.autoStartWork = el.autoStartWork.classList.contains('active');
                saveState();
            };

            el.soundEnabled.onclick = () => {
                el.soundEnabled.classList.toggle('active');
                state.settings.soundEnabled = el.soundEnabled.classList.contains('active');
                saveState();
            };

            el.themeButtons.forEach(btn => btn.onclick = () => setTheme(btn.dataset.theme));
            el.resetDefaults.onclick = resetToDefaults;
            el.clearAllData.onclick = clearAllData;

            document.onkeydown = (e) => {
                if (e.target.tagName === 'INPUT') return;
                if (e.code === 'Space') { e.preventDefault(); state.isRunning && !state.isPaused ? pauseTimer() : startTimer(); }
                else if (e.code === 'KeyR' && !e.ctrlKey && !e.metaKey) resetTimer();
                else if (e.code === 'Escape') { closeShop(); closeSettings(); }
            };

            let resizeTimeout;
            window.onresize = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(drawAllLayers, 150);
            };
        }

        // ===== Init =====
        function init() {
            loadState();
            setTheme(state.settings.theme);
            initSettingsUI();
            initParticlePool();

            state.timeRemaining = state.settings.workDuration * 60;
            state.totalTime = state.settings.workDuration * 60;

            drawAllLayers();
            updateDisplay();
            updateSessionInfo();
            updateCoinDisplay();
            updateStatsDisplay();
            setupEvents();
        }

        init();
    </script>
</body>
</html>
